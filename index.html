<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å·¥å•è¯¦ç»†ä¿¡æ¯çœ‹æ¿</title>
  <style>
    :root {
      --bg-color: #f1f5f9;
      /* æ··å‡åœŸäº®ç° */
      --card-bg: #ffffff;
      --card-border: #cbd5e1;
      /* æ˜æ˜¾çš„ç²—è¾¹æ¡† */
      --primary: #2563eb;
      /* å·¥ä¸šè“ */
      --primary-glow: transparent;
      --success: #16a34a;
      /* ä¿¡å·ç»¿ */
      --success-glow: transparent;
      --warning: #ea580c;
      /* å®‰å…¨æ©™ */
      --danger: #dc2626;
      /* è­¦ç¤ºçº¢ */
      --text-main: #0f172a;
      /* æ·±é»‘ç° */
      --text-muted: #475569;
      /* ä¸­æ€§ç° */
      --border: #e2e8f0;
      --radius: 6px;
      /* å·¥ä¸šé£æ›´é”åˆ©çš„ç›´è§’è¾¹ç¼˜ */
      --shadow: 4px 4px 0px rgba(15, 23, 42, 0.08);
      /* æœºæ¢°æŠ•å½± */
      --shadow-lg: 6px 6px 0px rgba(15, 23, 42, 0.12);
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg-color);
      background-image:
        repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0, 0, 0, 0.01) 10px, rgba(0, 0, 0, 0.01) 20px);
      color: var(--text-main);
      margin: 0;
      padding: 12px 20px;
      line-height: 1.5;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }

    .header h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 800;
      color: var(--text-main);
      letter-spacing: -0.01em;
    }

    .header-meta {
      font-size: 14px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* Hero Metrics Dashboard */
    .hero-dashboard {
      display: grid;
      grid-template-columns: 1.4fr 0.8fr 0.8fr 0.8fr auto;
      gap: 24px;
      margin-bottom: 10px;
      background: var(--card-bg);
      border: 2px solid var(--card-border);
      padding: 16px 24px;
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      position: relative;
      overflow: hidden;
      align-items: center;
    }

    .hero-item {
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 4px;
      z-index: 1;
    }

    .hero-label {
      font-size: 11px;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .hero-value {
      font-size: 20px;
      font-weight: 800;
      letter-spacing: -0.01em;
      color: var(--text-main);
    }

    .hero-value.qty {
      font-size: 32px;
      color: var(--primary);
    }

    /* Compact Controls Navbar */
    .nav-tools {
      display: flex;
      gap: 12px;
      z-index: 10;
      position: relative;
    }

    .btn-tool {
      background: #f8fafc;
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      backdrop-filter: blur(4px);
      transition: all 0.2s;
    }

    /* Milestone info strip below hero */
    .milestone-strip {
      display: flex;
      gap: 16px;
      margin-top: 0;
      margin-bottom: 10px;
      background: #f8fafc;
      border: 1px dashed var(--card-border);
      padding: 8px 16px;
      border-radius: var(--radius);
      justify-content: flex-start;
      flex-wrap: wrap;
      align-items: center;
    }

    .ms-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ms-label {
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 500;
    }

    .ms-value {
      font-size: 13px;
      font-weight: 700;
      color: var(--text-main);
      background: var(--bg-color);
      padding: 4px 10px;
      border-radius: 4px;
      border: 1px solid var(--border);
    }

    .btn-return {
      padding: 0 16px;
      height: 32px;
      line-height: 32px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: white;
      color: var(--text-main);
      text-decoration: none;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      transition: all 0.2s;
    }

    .btn-return:hover {
      background: #f8fafc;
      border-color: #cbd5e1;
    }

    .btn-tool:hover {
      background: #e2e8f0;
      color: var(--text-main);
    }

    .controls-panel-mini {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 12px 20px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-5px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .controls-panel-mini .control-group {
      flex: 1;
      margin: 0;
    }

    .controls-panel-mini input {
      height: 32px;
      padding: 6px 12px;
      width: 100%;
      max-width: 400px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      outline: none;
      font-family: monospace;
      font-size: 14px;
    }

    .controls-panel-mini input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    }

    .hidden {
      display: none !important;
    }

    /* Dashboard Grid */
    .dashboard {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 24px;
      margin-bottom: 24px;
    }

    .dash-section {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .dash-section:hover {
      border-color: var(--text-muted);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .dash-title {
      font-size: 14px;
      font-weight: 800;
      color: var(--text-main);
      display: flex;
      justify-content: flex-start;
      width: 100%;
      text-decoration: none;
      white-space: nowrap;
    }

    .dash-title span {
      white-space: nowrap;
    }

    .dash-dot-std {
      width: 8px;
      height: 8px;
      background: var(--primary);
      border-radius: 50%;
      margin-right: 8px;
      flex-shrink: 0;
    }

    .dash-dot-proc {
      width: 8px;
      height: 8px;
      background: var(--warning);
      border-radius: 50%;
      margin-right: 8px;
      flex-shrink: 0;
    }

    /* Section Specifics */
    .section-std {
      grid-column: span 4;
    }

    .section-proc {
      grid-column: span 4;
    }

    .section-perf {
      grid-column: span 4;
    }

    /* Stat Cards within Sections */
    .stat-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .stat-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      /* å±…ä¸­å¡«å……ä¸­é—´ç©ºç™½ */
    }

    .stat-item {
      flex: 1;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .stat-number {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-main);
      line-height: 1;
    }

    .stat-sub {
      font-size: 12px;
      color: var(--text-muted);
      margin-left: 4px;
      font-weight: 400;
    }

    .donut-chart {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .donut-center-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      width: 100%;
      pointer-events: none;
    }

    .val.ok {
      color: var(--success);
    }

    .val.ng {
      color: var(--danger);
    }

    .val.pending {
      color: var(--warning);
    }

    .stat-card-box {
      background: #f8fafc;
      border: 1px dashed var(--card-border);
      border-radius: var(--radius);
      padding: 20px;
      margin-top: auto;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .stat-card-box:hover {
      background: #fef2f2;
      border-color: var(--danger);
      box-shadow: 4px 4px 0px rgba(220, 38, 38, 0.1);
      transform: translateY(-2px);
    }

    .stat-card-title {
      font-size: 13px;
      font-weight: 700;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .stat-card-value {
      font-size: 28px;
      font-weight: 800;
      color: var(--danger);
    }

    .stat-card-value.success {
      color: var(--success);
    }

    /* Donut Chart Enhancements */
    .donut-chart {
      position: relative;
    }

    .donut-ring {
      transform: rotate(-90deg);
      transform-origin: center;
      stroke-linecap: square;
      /* å·¥ä¸šæ„Ÿå¹³å¤´ */
      transition: stroke-dasharray 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .percentage {
      font-size: 20px;
      font-weight: 800;
      color: var(--text-main);
    }

    .percentage-label {
      font-size: 10px;
      color: var(--text-muted);
      font-weight: 600;
      text-transform: uppercase;
    }

    /* Detail Table */
    .detail-panel {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 24px;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes blink {
      0% {
        opacity: 1;
      }

      50% {
        opacity: 0;
      }

      100% {
        opacity: 1;
      }
    }

    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .detail-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-main);
    }

    .btn-close {
      background: var(--bg-color);
      border: 1px dashed var(--card-border);
      width: 36px;
      height: 36px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      transition: all 0.2s;
    }

    .btn-close:hover {
      background: #fef2f2;
      color: var(--danger);
      border-color: var(--danger);
    }

    .modern-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 8px;
    }

    .modern-table th {
      text-align: left;
      padding: 16px;
      font-size: 11px;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      border-bottom: 2px solid var(--border);
    }

    .modern-table td {
      padding: 16px;
      font-size: 14px;
      background: #fafafa;
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      color: var(--text-main);
      transition: all 0.2s;
    }

    .modern-table tr:hover td {
      background: #f1f5f9;
      color: var(--text-main);
    }

    /* Status Bar & Scrollbar */
    .status-bar {
      margin-top: 24px;
      padding: 16px;
      background: #f8fafc;
      border: 1px dashed var(--card-border);
      border-radius: var(--radius);
      font-size: 13px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-color);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      background: var(--success);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
      }

      70% {
        box-shadow: 0 0 0 6px rgba(16, 185, 129, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
      }
    }

    .status-loading .status-dot {
      background: var(--warning);
      animation: none;
    }

    /* ===== Left-side Tab Layout ===== */
    .tab-layout {
      display: flex;
      gap: 0;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      min-height: auto;
    }

    .tab-sidebar {
      width: 120px;
      flex-shrink: 0;
      background: #f8fafc;
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      padding: 16px 0;
      gap: 4px;
    }

    .tab-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 18px 8px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      transition: all 0.2s;
      border-left: 3px solid transparent;
      text-align: center;
      line-height: 1.3;
    }

    .tab-btn .tab-icon {
      font-size: 22px;
    }

    .tab-btn:hover {
      background: #eef2ff;
      color: var(--primary);
    }

    .tab-btn.active {
      background: #eff6ff;
      color: var(--primary);
      border-left-color: var(--primary);
      font-weight: 700;
    }

    .tab-panels {
      flex: 1;
      overflow: auto;
    }

    .tab-panel {
      display: none;
      padding: 24px;
    }

    .tab-panel.active {
      display: block;
    }

    /* === Hours section inside tab === */
    .hours-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
        <h1 class="page-title">
          <span class="icon">ğŸ“¦</span>
          å·¥å•è¯¦ç»†ä¿¡æ¯çœ‹æ¿
        </h1>
        <div style="display: flex; gap: 12px; align-items: center;">
          <x-auth-shield id="authShield" style="display: flex; gap: 12px; align-items: center;">
            <!-- ä¼šåœ¨æ­¤å¤„é€šè¿‡ JS æ³¨å…¥æƒé™ç›¸å…³çš„æŒ‰é’®/æ ‡è¯† -->
          </x-auth-shield>
        </div>
      </div>
    </div>

    <!-- Hero Dashboard (The new metrics view) -->
    <div class="hero-dashboard" id="heroDashboard">
      <div class="hero-item">
        <div class="hero-label">å·¥å•ç¼–å·</div>
        <input type="text" id="workOrder" onkeypress="handleEnter(event)" placeholder="æŸ¥å¯»å·¥å•..."
          style="background: #ffffff; border: 2px solid #cbd5e1; border-radius: 8px; color: #1e293b; width: 260px; font-weight: 800; font-size: 20px; outline: none; padding: 8px 12px; transition: border 0.2s; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);"
          onfocus="this.style.borderColor='#2563eb'" onblur="this.style.borderColor='#cbd5e1'" />
        <div class="hero-value" id="heroWorkOrder" style="display: none;">-</div>
      </div>

      <div class="hero-item">
        <div class="hero-label">é¡¹ç›®åç§°</div>
        <div class="hero-value" id="heroProject">-</div>
      </div>

      <div class="hero-item">
        <div class="hero-label">å·¥å•æ•°é‡</div>
        <div class="hero-value qty" id="heroOrderQty">-</div>
      </div>

      <div class="hero-item">
        <div class="hero-label">çŠ¶æ€</div>
        <div class="hero-value" id="heroStatusText">ç­‰å¾…ä¸­</div>
      </div>
      <div class="hero-item" style="display: none;">
        <div class="hero-label">å¤–åå·¥æ—¶ (CSV)</div>
        <div class="hero-value" id="outsourceCsvTotal" style="color: var(--warning);">-</div>
      </div>

      <div class="nav-tools"
        style="display: flex; align-items: center; justify-content: center; margin-left: auto; z-index: 9999; position: relative;">
        <button id="heroSearchBtn" class="btn-tool" onmousedown="typeof loadData==='function' ? loadData() : null"
          onclick="typeof loadData==='function' ? loadData() : null"
          style="background: var(--primary); color: white; border: none; font-weight: 800; font-size: 16px; padding: 12px 24px; box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3); cursor: pointer !important; position: relative; z-index: 9999;">ğŸ“Š
          ç»Ÿè®¡</button>
      </div>
    </div>

    <!-- Milestone strip appended right below hero -->
    <div class="milestone-strip" id="milestoneStrip" style="display: none;">
      <div class="ms-item">
        <span class="ms-label">ç»„è£…å¼€å§‹:</span>
        <span class="ms-value" id="msAssemblyStart">-</span>
      </div>
      <div class="ms-item">
        <span class="ms-label">ç»„è£…ç»“æŸ:</span>
        <span class="ms-value" id="msAssemblyEnd">-</span>
      </div>
      <div class="ms-item" style="margin-left: 12px; border-left: 1px solid var(--border); padding-left: 24px;">
        <span class="ms-label">è°ƒè¯•å¼€å§‹:</span>
        <span class="ms-value" id="msDebugStart">-</span>
      </div>
      <div class="ms-item">
        <span class="ms-label">è°ƒè¯•ç»“æŸ:</span>
        <span class="ms-value" id="msDebugEnd">-</span>
      </div>
      <div class="ms-item" style="margin-left: 12px; border-left: 1px solid var(--border); padding-left: 24px;">
        <span class="ms-label">å‡ºè´§æ—¶é—´:</span>
        <span class="ms-value" id="msShipStart" style="color: var(--primary);"></span>
      </div>
    </div>

    <!-- Compact Search Panel (Hidden by default or toggled) -->
    <div class="controls-panel-mini hidden" id="searchPanel" style="display: none !important;">
      <div class="control-group"></div>
      <button id="retryBtn" class="btn-primary"
        style="height: 32px; padding: 0 16px; background: #059669; display: none;" onclick="retryFetch()">ğŸ“¥
        é‡æ–°è·å–æ•°æ®</button>

      <div id="hiddenConfig" style="display:none;">
        <input id="stdPrefix" value="éåŠ å·¥ä»¶" />
        <input id="procPrefix" value="7." />
        <select id="partField"></select>
        <select id="receiptField"></select>
      </div>
    </div>

    <!-- Left-side Tab Layout -->
    <div class="tab-layout">

      <!-- Sidebar Tab Buttons -->
      <div class="tab-sidebar">
        <button class="tab-btn active" id="tabBtn0" onmousedown="switchTab(0)">
          <span class="tab-icon">ğŸ“¦</span>
          ç‰©æ–™ä¿¡æ¯
        </button>
        <button class="tab-btn" id="tabBtn1" onmousedown="switchTab(1)">
          <span class="tab-icon">â±ï¸</span>
          å·¥æ—¶ä¿¡æ¯
        </button>
      </div>

      <!-- Tab Content Panels -->
      <div class="tab-panels">

        <!-- Panel 0: ç‰©æ–™ä¿¡æ¯ -->
        <div class="tab-panel active" id="tabPanel0">
          <div class="dashboard">
            <!-- Standard Parts -->
            <div class="dash-section section-std">
              <div class="dash-title std" style="align-items: flex-start;">
                <div
                  style="display: flex; flex-direction: column; align-items: flex-start; margin-top: 8px; gap: 24px;">
                  <div style="display: flex; align-items: center;">
                    <div class="dash-dot-std"></div>
                    <span>æ ‡å‡†ä»¶æ¦‚è§ˆ</span>
                  </div>
                  <div style="display: flex; flex-direction: column; gap: 4px;">
                    <div style="font-size: 12px; font-weight: 600; color: var(--text-muted);">æ€»è¡Œæ•°</div>
                    <div style="display: flex; align-items: baseline; gap: 4px;">
                      <span id="stdRows"
                        style="font-size: 24px; font-weight: 800; color: var(--text-main); line-height: 1;">-</span>
                      <span style="font-size: 12px; font-weight: 500; color: var(--text-muted);">(<span
                          id="stdTotal">-</span> æ¬¾)</span>
                    </div>
                    <div
                      style="font-size: 11px; color: #94a3b8; font-weight: normal; margin-top: -2px; white-space: nowrap;">
                      *åŸºäºç³»ç»Ÿå¯¼å‡ºçš„è¡Œæ•°ç»Ÿè®¡
                    </div>
                  </div>
                </div>
                <div style="margin-left: auto; display: flex; align-items: center; gap: 16px;">
                  <div
                    style="display: flex; flex-direction: column; gap: 4px; padding: 4px 10px; background: #f8fafc; border: 1px dashed var(--border); border-radius: 6px; font-size: 12px; font-weight: 600; line-height: 1.2; text-align: left;">
                    <div
                      style="font-size: 11px; color: var(--text-muted); text-align: center; border-bottom: 1px dashed var(--border); padding-bottom: 4px; margin-bottom: 2px;">
                      å‡†æ—¶è¾¾äº¤</div>
                    <div style="display: flex; flex-direction: column; gap: 4px;">
                      <div
                        style="display: flex; justify-content: space-between; align-items: baseline; color: var(--success); width: 100%;">
                        <span>OK:</span>
                        <span id="onTimeOkStd"
                          style="text-align: right; font-size: 12px; margin-left: 8px; font-weight: bold;">-</span>
                      </div>
                      <div
                        style="display: flex; justify-content: space-between; align-items: baseline; color: var(--danger); width: 100%;">
                        <span>NG:</span>
                        <span id="onTimeNgStd"
                          style="text-align: right; font-size: 12px; margin-left: 8px; font-weight: bold;">-</span>
                      </div>
                    </div>
                  </div>
                  <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                    <div class="donut-chart" style="width: 70px; height: 70px;">
                      <svg viewBox="0 0 36 36" style="transform: rotate(-90deg);">
                        <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                          fill="none" stroke="#e2e8f0" stroke-width="3" />
                        <path id="donutRingStd"
                          d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none"
                          stroke="#10b981" stroke-width="3" stroke-dasharray="0, 100" class="donut-ring" />
                      </svg>
                    </div>
                    <div style="font-size: 18px; font-weight: 800; color: var(--text-main); line-height: 1;"
                      id="onTimeRateStd">-</div>
                  </div>
                </div>
              </div>
              <div class="stat-card-box" onclick="showUndelivered('std')">
                <div class="stat-card-title">
                  <span>æœªäº¤è´§æ˜ç»† (ç‚¹å‡»æŸ¥çœ‹)<br><small
                      style="font-size:11px; font-weight:normal; color:#94a3b8;">*æŒ‰ç…§è¡Œæ•°ç»Ÿè®¡</small></span>
                  <span>â†—</span>
                </div>
                <div class="stat-card-value" id="stdUndelivered" style="display:flex; align-items:baseline; gap:8px;">-
                </div>
              </div>
            </div>

            <!-- Processed Parts -->
            <div class="dash-section section-proc">
              <div class="dash-title proc" style="align-items: flex-start;">
                <div
                  style="display: flex; flex-direction: column; align-items: flex-start; margin-top: 8px; gap: 24px;">
                  <div style="display: flex; align-items: center;">
                    <div class="dash-dot-proc"></div>
                    <span>åŠ å·¥ä»¶æ¦‚è§ˆ</span>
                  </div>
                  <div style="display: flex; flex-direction: column; gap: 4px;">
                    <div style="font-size: 12px; font-weight: 600; color: var(--text-muted);">æ€»è¡Œæ•°</div>
                    <div style="display: flex; align-items: baseline; gap: 4px;">
                      <span id="procRows"
                        style="font-size: 24px; font-weight: 800; color: var(--text-main); line-height: 1;">-</span>
                      <span style="font-size: 12px; font-weight: 500; color: var(--text-muted);">(<span
                          id="procTotal">-</span> æ¬¾)</span>
                    </div>
                    <div
                      style="font-size: 11px; color: #94a3b8; font-weight: normal; margin-top: -2px; white-space: nowrap;">
                      *åŸºäºç³»ç»Ÿå¯¼å‡ºçš„è¡Œæ•°ç»Ÿè®¡
                    </div>
                  </div>
                </div>
                <div style="margin-left: auto; display: flex; align-items: center; gap: 16px;">
                  <div
                    style="display: flex; flex-direction: column; gap: 4px; padding: 4px 10px; background: #f8fafc; border: 1px dashed var(--border); border-radius: 6px; font-size: 12px; font-weight: 600; line-height: 1.2; text-align: left;">
                    <div
                      style="font-size: 11px; color: var(--text-muted); text-align: center; border-bottom: 1px dashed var(--border); padding-bottom: 4px; margin-bottom: 2px;">
                      å‡†æ—¶è¾¾äº¤</div>
                    <div style="display: flex; flex-direction: column; gap: 4px;">
                      <div
                        style="display: flex; justify-content: space-between; align-items: baseline; color: var(--success); width: 100%;">
                        <span>OK:</span>
                        <span id="onTimeOkProc"
                          style="text-align: right; font-size: 12px; margin-left: 8px; font-weight: bold;">-</span>
                      </div>
                      <div
                        style="display: flex; justify-content: space-between; align-items: baseline; color: var(--danger); width: 100%;">
                        <span>NG:</span>
                        <span id="onTimeNgProc"
                          style="text-align: right; font-size: 12px; margin-left: 8px; font-weight: bold;">-</span>
                      </div>
                      <div
                        style="display: flex; justify-content: space-between; align-items: baseline; color: var(--warning); width: 100%;">
                        <span>å¾…æ£€:</span>
                        <span id="pendingIqc"
                          style="text-align: right; font-size: 12px; margin-left: 8px; font-weight: bold;">-</span>
                      </div>
                    </div>
                  </div>
                  <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                    <div class="donut-chart" style="width: 70px; height: 70px;">
                      <svg viewBox="0 0 36 36" style="transform: rotate(-90deg);">
                        <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                          fill="none" stroke="#e2e8f0" stroke-width="3" />
                        <path id="donutRingProc"
                          d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none"
                          stroke="#10b981" stroke-width="3" stroke-dasharray="0, 100" class="donut-ring" />
                      </svg>
                    </div>
                    <div style="font-size: 18px; font-weight: 800; color: var(--text-main); line-height: 1;"
                      id="onTimeRateProc">-</div>
                  </div>
                </div>
              </div>
              <div class="stat-card-box" onclick="showUndelivered('proc')">
                <div class="stat-card-title">
                  <span>æœªäº¤è´§æ˜ç»† (ç‚¹å‡»æŸ¥çœ‹)<br><small
                      style="font-size:11px; font-weight:normal; color:#94a3b8;">*æŒ‰ç…§è¡Œæ•°ç»Ÿè®¡</small></span>
                  <span>â†—</span>
                </div>
                <div class="stat-card-value" id="procUndelivered" style="display:flex; align-items:baseline; gap:8px;">-
                </div>
              </div>
            </div>

            <!-- Cycle Time Performance -->
            <div class="dash-section section-perf">
              <div class="dash-title">é‡‡è´­å‘¨æœŸç›®æ ‡è¾¾æˆæƒ…å†µ</div>
              <div class="stat-body" style="flex-direction: column; gap: 16px;">
                <div style="display: flex; flex-direction: column; width: 100%; gap: 16px;">
                  <div
                    style="flex: 1; display: flex; flex-direction: row; align-items: center; justify-content: space-between; background: #f8fafc; border: 1px dashed var(--card-border); border-radius: var(--radius); padding: 16px 20px;">
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                      <div style="font-size: 13px; font-weight: 700; color: var(--text-main);">æ ‡å‡†ä»¶ 10å¤©è¾¾æˆç‡</div>
                      <div style="display: flex; gap: 12px; font-size: 12px; margin-top: 4px;">
                        <span style="color: var(--success); font-weight: 600;">è¾¾æ ‡: <span id="stdCycleOk"
                            style="font-weight: 800;">-</span></span>
                        <span style="color: var(--danger); font-weight: 600;">è¶…æœŸ: <span id="stdCycleNg"
                            style="font-weight: 800;">-</span></span>
                        <span style="color: var(--text-muted); font-weight: 600;">æœªäº¤: <span id="stdCycleUn"
                            style="font-weight: 800;">-</span></span>
                      </div>
                    </div>
                    <div class="donut-chart" style="width: 54px; height: 54px; flex-shrink: 0;">
                      <svg viewBox="0 0 36 36" style="transform: rotate(-90deg);">
                        <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                          fill="none" stroke="#e2e8f0" stroke-width="3" />
                        <path id="stdCycleRing"
                          d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none"
                          stroke="#10b981" stroke-width="3" stroke-dasharray="0, 100" class="donut-ring" />
                      </svg>
                      <div class="donut-center-text">
                        <div class="percentage" style="font-size: 14px; font-weight: 800; color: var(--text-main);"
                          id="stdCycleRate">-</div>
                      </div>
                    </div>
                  </div>
                  <div
                    style="flex: 1; display: flex; flex-direction: row; align-items: center; justify-content: space-between; background: #f8fafc; border: 1px dashed var(--card-border); border-radius: var(--radius); padding: 16px 20px;">
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                      <div style="font-size: 13px; font-weight: 700; color: var(--text-main);">åŠ å·¥ä»¶ 7å¤©è¾¾æˆç‡</div>
                      <div style="display: flex; gap: 12px; font-size: 12px; margin-top: 4px;">
                        <span style="color: var(--success); font-weight: 600;">è¾¾æ ‡: <span id="procCycleOk"
                            style="font-weight: 800;">-</span></span>
                        <span style="color: var(--danger); font-weight: 600;">è¶…æœŸ: <span id="procCycleNg"
                            style="font-weight: 800;">-</span></span>
                        <span style="color: var(--text-muted); font-weight: 600;">æœªäº¤: <span id="procCycleUn"
                            style="font-weight: 800;">-</span></span>
                      </div>
                    </div>
                    <div class="donut-chart" style="width: 54px; height: 54px; flex-shrink: 0;">
                      <svg viewBox="0 0 36 36" style="transform: rotate(-90deg);">
                        <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                          fill="none" stroke="#e2e8f0" stroke-width="3" />
                        <path id="procCycleRing"
                          d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none"
                          stroke="#10b981" stroke-width="3" stroke-dasharray="0, 100" class="donut-ring" />
                      </svg>
                      <div class="donut-center-text">
                        <div class="percentage" style="font-size: 14px; font-weight: 800; color: var(--text-main);"
                          id="procCycleRate">-</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- END Panel 0 -->

        <!-- Panel 1: å·¥æ—¶ä¿¡æ¯ -->
        <div class="tab-panel" id="tabPanel1">
          <div class="hours-section-header">
            <h3 style="margin: 0; font-size: 16px; font-weight: 700; color: #4338ca;">â±ï¸ å®é™…å·¥æ—¶ç»Ÿè®¡</h3>
            <div style="display: flex; gap: 8px; align-items: center;">
              <button id="refreshLocalHoursBtn" class="btn-primary"
                style="background-color: #f59e0b; height: 36px; border: none;" onclick="refreshLocalHours()">
                <span class="btn-icon">ğŸ”„</span> æœ¬åœ°å·¥æ—¶åˆ·æ–°
              </button>
              <button class="btn-primary" style="background-color: #6366f1; height: 36px;" onclick="loadHoursData()">
                <span class="btn-icon">âš¡</span> åŠ è½½å·¥æ—¶æ•°æ®
              </button>
            </div>
          </div>
          <div id="hoursDashboard" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
            <!-- Assembly Hours -->
            <div id="hoursAssemblySection" class="dash-section"
              style="border-top: 4px solid #ef4444; position: relative;">
              <div class="dash-title" style="color: #dc2626; display: flex; justify-content: space-between;">
                <span>ç»„è£…å·¥æ—¶ (çº¢)</span>
                <span id="hoursAssemblyStatusIcon" style="font-size: 16px;"></span>
              </div>
              <div
                style="display: flex; justify-content: space-between; align-items: baseline; margin-top: 4px; margin-bottom: 8px;">
                <div class="stat-number" id="hoursAssemblyTotal" style="margin-bottom: 0;">-</div>
                <div class="stat-sub" style="margin-left: 0;">è®¡åˆ’: <span id="hoursAssemblyPlan">-</span> | <span
                    id="hoursAssemblyRate" style="font-weight:bold">-</span>%</div>
              </div>
              <div id="hoursAssemblyDetails" style="margin-top: 4px; display: flex; flex-direction: column; gap: 4px;">
              </div>
              <div class="stat-actions"
                style="display: flex; gap: 8px; margin-top: 12px; border-top: 1px dashed var(--border); padding-top: 12px;">
                <button class="btn-tool" onclick="openQuickEntry('assembly')"
                  style="flex: 1; font-size: 11px; padding: 6px;">å½•å…¥</button>
                <button class="btn-tool" onclick="openHoursComparison('assembly')"
                  style="flex: 1; font-size: 11px; padding: 6px; background: #fee2e2; color: #dc2626; border-color: #fca5a5;">æŸ¥è¯¢</button>
              </div>
            </div>
            <!-- Mixed Hours -->
            <div id="hoursMixedSection" class="dash-section" style="border-top: 4px solid #3b82f6; position: relative;">
              <div class="dash-title" style="color: #2563eb; display: flex; justify-content: space-between;">
                <span>æ··åˆå·¥æ—¶ (è“)</span>
                <span id="hoursMixedStatusIcon" style="font-size: 16px;"></span>
              </div>
              <div
                style="display: flex; justify-content: space-between; align-items: baseline; margin-top: 4px; margin-bottom: 8px;">
                <div class="stat-number" id="hoursMixedTotal" style="margin-bottom: 0;">-</div>
                <div class="stat-sub" style="margin-left: 0;">è®¡åˆ’: <span id="hoursMixedPlan">-</span> | <span
                    id="hoursMixedRate" style="font-weight:bold">-</span>%</div>
              </div>
              <div id="hoursMixedDetails" style="margin-top: 4px; display: flex; flex-direction: column; gap: 4px;">
              </div>
              <div class="stat-actions"
                style="display: flex; gap: 8px; margin-top: 12px; border-top: 1px dashed var(--border); padding-top: 12px;">
                <button class="btn-tool" onclick="openQuickEntry('mixed')"
                  style="flex: 1; font-size: 11px; padding: 6px;">å½•å…¥</button>
                <button class="btn-tool" onclick="openHoursComparison('mixed')"
                  style="flex: 1; font-size: 11px; padding: 6px; background: #dbeafe; color: #2563eb; border-color: #93c5fd;">æŸ¥è¯¢</button>
              </div>
            </div>
            <!-- Wiring Hours -->
            <div id="hoursWiringSection" class="dash-section"
              style="border-top: 4px solid #10b981; position: relative;">
              <div class="dash-title" style="color: #059669; display: flex; justify-content: space-between;">
                <span>æ¥çº¿å·¥æ—¶ (ç»¿)</span>
                <span id="hoursWiringStatusIcon" style="font-size: 16px;"></span>
              </div>
              <div
                style="display: flex; justify-content: space-between; align-items: baseline; margin-top: 4px; margin-bottom: 8px;">
                <div class="stat-number" id="hoursWiringTotal" style="margin-bottom: 0;">-</div>
                <div class="stat-sub" style="margin-left: 0;">è®¡åˆ’: <span id="hoursWiringPlan">-</span> | <span
                    id="hoursWiringRate" style="font-weight:bold">-</span>%</div>
              </div>
              <div id="hoursWiringDetails" style="margin-top: 4px; display: flex; flex-direction: column; gap: 4px;">
              </div>
              <div class="stat-actions"
                style="display: flex; gap: 8px; margin-top: 12px; border-top: 1px dashed var(--border); padding-top: 12px;">
                <button class="btn-tool" onclick="openQuickEntry('wiring')"
                  style="flex: 1; font-size: 11px; padding: 6px;">å½•å…¥</button>
                <button class="btn-tool" onclick="openHoursComparison('wiring')"
                  style="flex: 1; font-size: 11px; padding: 6px; background: #dcfce7; color: #059669; border-color: #86efac;">æŸ¥è¯¢</button>
              </div>
            </div>
          </div>
          <!-- å¯¹æ¯”è§†å›¾åŒºåŸŸ -->
          <div id="hoursComparisonView" style="display: none; margin-top: 24px; animation: fadeIn 0.3s ease;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h4 id="comparisonTitle" style="margin: 0; font-size: 15px; color: var(--text-main);">ğŸ” æ•°æ®æ ¸å¯¹ï¼šKIMD ç³»ç»Ÿ vs
                CSV æ•°æ®åº“</h4>
              <button class="btn-tool" onclick="closeComparison()">è¿”å›æ•´ä½“æ¦‚è§ˆ</button>
            </div>
            <div id="comparisonContent"
              style="background: #ffffff; border: 1px solid var(--card-border); border-radius: 8px; overflow: hidden;">
              <!-- å¯¹æ¯”è¡¨æ ¼å°†åœ¨æ­¤æ³¨å…¥ -->
            </div>
          </div>

          <div id="hoursEmpty" style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
            <div style="font-size: 48px; margin-bottom: 16px;">â³</div>
            <div style="font-size: 16px; font-weight: 600;">ç‚¹å‡»â€œåŠ è½½å·¥æ—¶æ•°æ®â€æŒ‰é’®å¼€å§‹è·å–è¯¥å·¥å•çš„å·¥æ—¶æ•°æ®</div>
          </div>
        </div>
        <!-- END Panel 1 -->

      </div>
      <!-- END tab-panels -->
    </div>
    <!-- END tab-layout -->

    <div class="status-bar">
      <div class="status-dot"></div>
      <div id="status">ç³»ç»Ÿå°±ç»ªï¼Œç­‰å¾…è¾“å…¥...</div>
    </div>

    <!-- Detail Panel -->
    <div class="detail-panel hidden" id="detailPanel">
      <div class="detail-header">
        <div class="detail-title" id="detailTitle">æœªäº¤è´§æ˜ç»†</div>
        <button class="btn-close" onclick="closeDetail()">âœ•</button>
      </div>
      <div style="overflow-x: auto; max-height: 500px; overflow-y: auto;">
        <table class="modern-table">
          <thead>
            <tr>
              <th width="60">åºå·</th>
              <th>æ–™å·</th>
              <th>åç§°</th>
              <th>è§„æ ¼å‹å·</th>
              <th width="100" style="text-align:right">æ•°é‡</th>
              <th width="140" style="text-align:center">é‡‡è´­å›å¤åˆ°æ–™æ—¥æœŸ</th>
            </tr>
          </thead>
          <tbody id="detailBody">
          </tbody>
        </table>
      </div>
    </div>

    <!-- Quick Entry Panel -->
    <div class="detail-panel hidden" id="quickEntryPanel" style="margin-top: 24px; max-width: 100%; width: 100%;">
      <div class="detail-header">
        <div class="detail-title" id="quickEntryTitle">âš¡ å¿«æ·å½•å…¥</div>
        <div style="display: flex; gap: 24px; align-items: center;">
          <div
            style="display: flex; gap: 8px; align-items: center; background: #f1f5f9; padding: 4px 12px; border-radius: 6px; border: 1px solid #e2e8f0;">
            <label style="font-size: 13px; font-weight: 600; color: #475569;">å½•å…¥æ—¥æœŸ:</label>
            <input type="date" id="quickEntryGlobalDate"
              style="border:none; background:transparent; font-size: 13px; color: var(--primary); font-weight: 700; outline: none;">
          </div>
          <div id="quickEntryMeta" style="font-size: 13px; color: var(--text-muted);">å·¥å•ï¼š-</div>
          <button class="btn-close" onclick="closeQuickEntry()">âœ•</button>
        </div>
      </div>
      <div style="overflow-x: auto; max-height: 500px; overflow-y: auto;">
        <table class="modern-table" style="margin-top: 0; min-width: 1000px;">
          <thead>
            <tr>
              <th width="90">å§“å</th>
              <th width="80">ç­‰çº§</th>
              <th width="80">å±æ€§</th>
              <th width="100">å¤–åå•ä½</th>
              <th width="110">å·¥æ—¶æŒ‚é </th>
              <th width="85">æ—¶é—´(èµ·)</th>
              <th width="85">æ—¶é—´(æ­¢)</th>
              <th width="80">å·¥æ—¶(h)</th>
              <th width="150">å¤‡æ³¨</th>
              <th width="100" style="text-align:center">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="quickEntryBody">
          </tbody>
        </table>
      </div>
      <div style="margin-top: 16px; display: flex; justify-content: flex-end; gap: 12px; align-items: center;">
        <span style="font-size: 12px; color: #94a3b8;">* æ‰€æœ‰ä¿¡æ¯å‡å¯ä¿®æ”¹ã€‚å·¥æ—¶å°†æ ¹æ® Excel å…¬å¼è‡ªåŠ¨æ ¸ç®—å¹¶æ‰£é™¤ä¼‘æ¯ã€‚</span>
        <button class="btn-tool" onclick="addQuickEntryRow()"
          style="background: #f1f5f9; border-color: #cbd5e1; color: #475569;">â• å¢åŠ è¡Œ</button>
        <button class="btn-primary" onclick="saveAllQuickEntries()" style="background: #10b981;">ä¸€é”®ä¿å­˜æ‰€æœ‰</button>
      </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModalOverlay"
      style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.6); align-items: center; justify-content: center; z-index: 10000; backdrop-filter: blur(4px);">
      <div
        style="background: white; border-radius: 12px; padding: 40px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); width: 360px;">
        <h2 style="text-align: center; color: #333; margin-top: 0; margin-bottom: 24px;">ğŸ”‘ ç³»ç»Ÿç™»å½•</h2>
        <div id="loginError"
          style="display: none; padding: 12px 16px; border-radius: 6px; margin-bottom: 16px; font-size: 14px; background: #fff2f0; border: 1px solid #ffccc7; color: #ff4d4f;">
        </div>
        <div style="margin-bottom: 16px; display: flex; flex-direction: column; gap: 6px;">
          <label style="font-size: 13px; font-weight: 600; color: #555;">è´¦å·</label>
          <input type="text" id="modalUserCode" placeholder="è¯·è¾“å…¥è´¦å·" value="wangjian"
            style="padding: 10px 14px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 14px; outline: none;">
        </div>
        <div style="margin-bottom: 24px; display: flex; flex-direction: column; gap: 6px;">
          <label style="font-size: 13px; font-weight: 600; color: #555;">å¯†ç </label>
          <input type="password" id="modalPassword" placeholder="è¯·è¾“å…¥å¯†ç "
            style="padding: 10px 14px; border: 1px solid #d9d9d9; border-radius: 6px; font-size: 14px; outline: none;"
            onkeypress="if(event.key==='Enter') loginUser()">
        </div>
        <div style="display: flex; gap: 12px;">
          <button
            style="flex: 1; padding: 12px 0; border: 1px solid var(--border); border-radius: 6px; background: #f8fafc; color: var(--text-main); font-size: 14px; font-weight: 600; cursor: pointer;"
            onclick="closeLoginModal()">å– æ¶ˆ</button>
          <button
            style="flex: 1; padding: 12px 0; border: none; border-radius: 6px; background: var(--primary); color: white; font-size: 14px; font-weight: 600; cursor: pointer;"
            onclick="loginUser()">ç™» å½•</button>
        </div>
      </div>
    </div>
  </div>
  <script src="material_stats_core.js?v=20250225_v3"></script>
  <script>
    console.log('[Stats] HTML entry script active.');
    // è‡ªåŠ¨é‡è¯•å¯åŠ¨æœºåˆ¶
    (function runner() {
      if (typeof bootstrap === 'function') {
        console.log('[Stats] Core library found, booting...');
        bootstrap();
      } else {
        console.warn('[Stats] Waiting for core library...');
        setTimeout(runner, 100);
      }
    })();

    // æƒé™ä¸è®¿å®¢æ‹¦æˆªå™¨
    document.addEventListener('DOMContentLoaded', () => {
      const shield = document.getElementById('authShield');
      const uStr = localStorage.getItem('currentUser');
      const cPanel = document.getElementById('searchPanel'); // æ—§ç‰ˆæŸ¥è¯¢åŒºåŸŸ
      const detailBtn = document.querySelector('.controls-panel-mini'); // æŸäº›æ—§çš„åŒºåŸŸéœ€è¦éšè—ä¹Ÿè¡Œ

      if (uStr) {
        const u = JSON.parse(uStr);
        // å¦‚æœæ˜¯è¶…çº§ç®¡ç†å‘˜æˆ–è€…æ˜¯åå°æˆæƒçš„ Admin
        const isAdmin = u.userCode === 'wangjian' || u.role === 'admin';
        shield.innerHTML = `
          <span style="color:#0ea5e9; font-weight:600; background:#e0f2fe; padding:4px 12px; border-radius:12px; font-size:13px;">ğŸ‘¤ ${u.userName} (${isAdmin ? 'ç®¡ç†å‘˜' : 'æˆæƒå‘˜å·¥'})</span>
          ${isAdmin ? '<button class="btn-return" style="background: #ffffff; color: #1a73e8; border-color: #1a73e8;" onclick="window.open(\'ç‰©æ–™æŸ¥è¯¢å·¥å…·.html\', \'_blank\')">ğŸ—ºï¸ é¡¹ç›®æ’ç¨‹</button>' : ''}
          <button class="btn-return" style="color:#dc2626; border-color:#fecaca;" onclick="logout()">é€€å‡ºç™»å½•</button>
          ${isAdmin ? '<button class="btn-return" style="background: #ffffff; color: var(--text-main); border-color: var(--border);" onclick="window.open(\'outsource_manage.html\', \'_blank\')">ğŸ—„ï¸ è®¾ç½®ä¸ç®¡ç†ä¸­å¿ƒ</button>' : ''}
        `;
        // å…è®¸æ“ä½œé¢æ¿
        if (cPanel) cPanel.classList.remove('hidden');
      } else {
        // æ¸¸å®¢æ¨¡å¼
        shield.innerHTML = `
          <span style="color:#64748b; font-weight:600; background:#f1f5f9; padding:4px 12px; border-radius:12px; font-size:13px;">ğŸ‘ï¸ æ¸¸å®¢æ¨¡å¼ (åªè¯»)</span>
          <button class="btn-return" style="color:var(--primary); border-color:var(--primary);" onclick="openLoginModal()">ç™» å½•</button>
        `;
        if (cPanel) cPanel.classList.add('hidden');
      }
    });

    function openLoginModal() {
      document.getElementById('loginModalOverlay').style.display = 'flex';
    }

    function closeLoginModal() {
      document.getElementById('loginModalOverlay').style.display = 'none';
      const el = document.getElementById('loginError');
      if (el) el.style.display = 'none';
    }

    async function loginUser() {
      const userCode = document.getElementById('modalUserCode').value.trim();
      const password = document.getElementById('modalPassword').value;
      const errorEl = document.getElementById('loginError');

      if (!userCode || !password) {
        errorEl.textContent = 'è¯·è¾“å…¥è´¦å·å’Œå¯†ç ';
        errorEl.style.display = 'block';
        return;
      }

      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userCode, password })
        });

        const result = await response.json();

        if (result.success) {
          const user = { userName: result.data.userName, userCode, role: result.data.role, department: result.data.department };
          localStorage.setItem('currentUser', JSON.stringify(user));
          location.reload();
        } else {
          errorEl.textContent = result.message || 'ç™»å½•å¤±è´¥';
          errorEl.style.display = 'block';
        }
      } catch (error) {
        errorEl.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯åŠ¨';
        errorEl.style.display = 'block';
      }
    }

    function logout() {
      localStorage.removeItem('currentUser');
      location.reload();
    }

    // é¡µç­¾åˆ‡æ¢å‡½æ•°
    function switchTab(index) {
      document.querySelectorAll('.tab-btn').forEach(function (btn, i) {
        btn.classList.toggle('active', i === index);
      });
      document.querySelectorAll('.tab-panel').forEach(function (panel, i) {
        panel.classList.toggle('active', i === index);
      });
      // åˆ‡æ¢åˆ°å·¥æ—¶é¡µç­¾æ—¶ï¼Œéšè—æœªåˆ°æ–™æ˜ç»†åˆ—è¡¨
      if (index !== 0) {
        const detailPanel = document.getElementById('detailPanel');
        if (detailPanel) detailPanel.classList.add('hidden');
      } else {
        // å½“åˆ‡æ¢åˆ°â€œç‰©æ–™ä¿¡æ¯â€é¡µç­¾ï¼ˆindex === 0ï¼‰æ—¶ï¼Œéšè—å¿«æ·å½•å…¥é¢æ¿
        const quickEntryPanel = document.getElementById('quickEntryPanel');
        if (quickEntryPanel) quickEntryPanel.classList.add('hidden');
      }
    }

    // â˜… é‡ç½®å·¥æ—¶é¢æ¿å›ç©ºç™½çŠ¶æ€ï¼ˆæ¢å·¥å•æ—¶è°ƒç”¨ï¼‰
    function resetHoursPanel() {
      const dash = document.getElementById('hoursDashboard');
      const empty = document.getElementById('hoursEmpty');
      if (dash) dash.style.display = 'grid';
      if (empty) empty.style.display = 'none';
      // æ¸…ç©ºå„å·¥æ—¶æ•°å€¼æ˜¾ç¤º
      ['hoursAssemblyTotal', 'hoursAssemblyPlan', 'hoursAssemblyRate', 'hoursAssemblyKimd', 'hoursAssemblyOut',
        'hoursMixedTotal', 'hoursMixedPlan', 'hoursMixedRate', 'hoursMixedKimd', 'hoursMixedOut',
        'hoursWiringTotal', 'hoursWiringPlan', 'hoursWiringRate', 'hoursWiringKimd', 'hoursWiringOut'
      ].forEach(function (id) {
        const el = document.getElementById(id);
        if (el) el.textContent = '-';
      });
      ['tagsAssembly', 'tagsMixed', 'tagsWiring'].forEach(function (id) {
        const el = document.getElementById(id);
        if (el) el.innerHTML = '';
      });
    }

    // æ‹¦æˆª loadDataï¼ˆç»Ÿè®¡æŒ‰é’®è°ƒç”¨çš„å‡½æ•°ï¼‰ï¼ŒæŸ¥è¯¢æ–°å·¥å•å‰é‡ç½®å·¥æ—¶é¢æ¿
    var _origLoadData;
    document.addEventListener('DOMContentLoaded', function () {
      setTimeout(function patchLoadData() {
        if (typeof loadData === 'function') {
          _origLoadData = loadData;
          window.loadData = function () {
            resetHoursPanel(); // â† é‡ç½®å·¥æ—¶é¢æ¿ï¼ˆé˜²æ­¢æ˜¾ç¤ºæ—§å·¥å•æ•°æ®ï¼‰
            _origLoadData();   // â† åŠ è½½ç‰©æ–™æ•°æ®
          };
        } else {
          setTimeout(patchLoadData, 100);
        }
      }, 200);

      // â˜… æ‹¦æˆª applyStatsFromMessage â€”â€” ç‰©æ–™æ•°æ®çœŸæ­£å†™å…¥å®Œæˆåæ‰è§¦å‘å·¥æ—¶åŠ è½½
      // è¿™æ˜¯æœ€ç²¾å‡†çš„å®Œæˆä¿¡å·ï¼Œå®Œå…¨é¿å…ä¸¤ä¸ªä»»åŠ¡åŒæ—¶ç«äº‰æ–‡ä»¶ç›‘å¬å™¨
      setTimeout(function patchApplyStats() {
        if (typeof applyStatsFromMessage === 'function') {
          var _origApply = applyStatsFromMessage;
          window.applyStatsFromMessage = function (payload) {
            _origApply(payload); // â† å…ˆæ‰§è¡ŒåŸå§‹ç‰©æ–™æ•°æ®æ¸²æŸ“
            // ç‰©æ–™å·²å®Œæˆï¼Œå»¶è¿Ÿ 300ms å†å¯åŠ¨å·¥æ—¶ï¼ˆè®©æ¸²æŸ“å…ˆç»“æŸï¼‰
            setTimeout(function () {
              if (typeof loadHoursData === 'function') {
                console.log('[AutoFlow] ç‰©æ–™ç»Ÿè®¡å®Œæˆï¼Œè‡ªåŠ¨è§¦å‘å·¥æ—¶åŠ è½½...');
                loadHoursData();
              }
            }, 300);
          };
          console.log('[AutoFlow] applyStatsFromMessage æ‹¦æˆªæˆåŠŸ');
        } else {
          setTimeout(patchApplyStats, 100);
        }
      }, 200);

      // åŠ è½½å·¥æ—¶æ•°æ®å¹¶æ˜¾ç¤º hoursDashboard
      setTimeout(function patchHours() {
        if (typeof loadHoursData === 'function') {
          var _orig = loadHoursData;
          window.loadHoursData = function () {
            const dash = document.getElementById('hoursDashboard');
            const empty = document.getElementById('hoursEmpty');
            if (dash) dash.style.display = 'grid';
            if (empty) empty.style.display = 'none';
            _orig();
          };
        } else {
          setTimeout(patchHours, 100);
        }
      }, 200);
    });

    // ======= æœ¬åœ°å·¥æ—¶åˆ·æ–°é€»è¾‘ =======
    async function refreshLocalHours() {
      const wo = document.getElementById('workOrder').value.trim();
      if (!wo) {
        alert('è¯·å…ˆæŸ¥è¯¢æœ‰æ•ˆçš„å·¥å•å·');
        return;
      }

      const btn = document.getElementById('refreshLocalHoursBtn');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = 'â³ åˆ·æ–°ä¸­...';
      }

      try {
        const res = await fetch(`/api/outsource-hours?workOrder=${encodeURIComponent(wo)}`);
        const data = await res.json();

        if (data.success) {
          // åªæ›´æ–°æœ¬åœ°æ•°æ®çŠ¶æ€ï¼Œä¸ç¢°ç³»ç»Ÿæ•°æ®
          state.csvOutsourceData = data;

          // é‡æ–°æ¸²æŸ“å·¥æ—¶å¡ç‰‡ï¼ˆä»…æœ¬åœ°æ•°æ®åˆ—å’Œå¯¹æ¯”å›¾æ ‡ä¼šå˜åŒ–ï¼‰
          if (state.currentStats && state.currentStats.hoursStats) {
            renderHoursData(state.currentStats.hoursStats);
          }

          setStatus('æœ¬åœ°å·¥æ—¶æ•°æ®å·²åˆ·æ–° âœ…', false);
        } else {
          setStatus('æœ¬åœ°å·¥æ—¶åˆ·æ–°å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'), false);
        }
      } catch (err) {
        setStatus('æœ¬åœ°å·¥æ—¶åˆ·æ–°å‡ºé”™ï¼š' + err.message, false);
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = 'ğŸ”„ æœ¬åœ°å·¥æ—¶åˆ·æ–°';
        }
      }
    }

    // ======= å¿«æ·å½•å…¥é€»è¾‘ =======
    let currentSection = '';
    let currentWo = '';

    function ensureHalfHour(input) {
      if (!input.value) return;
      let [h, m] = input.value.split(':').map(Number);
      // å‘ä¸‹å–æ•´ï¼šä¸åˆ°30åˆ†ç®—00ï¼Œè¶…è¿‡30åˆ†ä¸åˆ°60ç®—30
      if (m < 30) {
        m = 0;
      } else {
        m = 30;
      }
      const newVal = String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
      if (input.value !== newVal) {
        input.value = newVal;
        // è§¦å‘è®¡ç®—
        const rowId = input.closest('tr') ? input.closest('tr').id : null;
        if (rowId && typeof calcQuickHours === 'function') {
          calcQuickHours(rowId);
        } else if (typeof calcHours === 'function') {
          calcHours();
        }
      }
    }

    async function openQuickEntry(section) {
      const wo = document.getElementById('workOrder').value || document.getElementById('heroWorkOrder').textContent;
      if (!wo || wo === '-') {
        alert('è¯·å…ˆæŸ¥è¯¢æœ‰æ•ˆçš„å·¥å•å·');
        return;
      }

      const btnTitle = section === 'assembly' ? 'ç»„è£…äººå‘˜' : (section === 'wiring' ? 'æ¥çº¿äººå‘˜' : 'æ··åˆäººå‘˜');
      document.getElementById('quickEntryTitle').innerText = 'âš¡ å¿«æ·å½•å…¥ï¼š' + btnTitle;
      document.getElementById('quickEntryMeta').innerText = 'å·¥å•ï¼š' + wo;

      currentSection = section; // ç°åœ¨ä¿å­˜çš„æ˜¯ assembly/mixed/wiring
      currentWo = wo;

      try {
        const res = await fetch(`/api/outsource-record/suggest?workOrder=${encodeURIComponent(wo)}&category=${encodeURIComponent(section)}`);
        const result = await res.json();

        // åˆå§‹åŒ–å…¨å±€æ—¥æœŸä¸ºå½“å¤©
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        document.getElementById('quickEntryGlobalDate').value = `${yyyy}-${mm}-${dd}`;

        if (result.success && result.data.length > 0) {
          renderQuickEntryTable(result.data, wo, section);
        } else {
          // å¦‚æœæ²¡æœ‰å†å²è®°å½•ï¼Œåˆå§‹åŒ–ä¸ºç©ºè¡¨æ ¼å¹¶è‡ªåŠ¨å¢åŠ ä¸€è¡Œ
          renderQuickEntryTable([], wo, section);
          addQuickEntryRow(null, section);
        }

        document.getElementById('quickEntryPanel').classList.remove('hidden');
        document.getElementById('quickEntryPanel').scrollIntoView({ behavior: 'smooth' });
      } catch (err) {
        alert('è·å–å»ºè®®äººå‘˜å¤±è´¥: ' + err.message);
      }
    }

    function renderQuickEntryTable(staff, wo, section) {
      const tbody = document.getElementById('quickEntryBody');
      tbody.innerHTML = ''; // æ¸…ç©º
      staff.forEach((s, index) => {
        addQuickEntryRow(s, section);
      });
    }

    function handleQuickCategoryChange(selectEl, rowId) {
      const row = document.getElementById(rowId);
      if (!row) return;
      const levelEl = row.querySelector('.qe-level');
      const supplierEl = row.querySelector('.qe-supplier');

      if (selectEl.value === 'KIMD') {
        levelEl.value = '';
        levelEl.disabled = true;
        levelEl.style.background = '#f1f5f9';

        supplierEl.value = '';
        supplierEl.disabled = true;
        supplierEl.style.background = '#f1f5f9';
      } else {
        levelEl.disabled = false;
        levelEl.style.background = 'white';

        supplierEl.disabled = false;
        supplierEl.style.background = 'white';
      }
    }

    function addQuickEntryRow(staffData = null, section = null) {
      const tbody = document.getElementById('quickEntryBody');
      const rowId = 'qe-' + Date.now() + '-' + Math.floor(Math.random() * 1000);

      // Ensure s is properly initialized
      const s = staffData || {
        worker_name: '',
        worker_level: 'å¤§å·¥',
        supplier: 'å¤–å', // Changed from '' to 'å¤–å' as per user's snippet
        category: 'å¤–å',
        content: section || currentSection || '',
        hours: 0 // New field as per user's snippet
      };

      // æ ¹æ®æ¿å—åŠ¨æ€å†³å®šå·¥è‰ºé€‰é¡¹ (æ”¯æŒå¤šç§ Key åŒ¹é…ï¼Œæé«˜å®¹é”™æ€§)
      let contentOptions = '<option value="">è¯·é€‰æ‹©...</option>';
      const sec = (section || currentSection || '').toLowerCase();

      const groups = {
        'assembly': ['ç»„è£…-è¿”å·¥', 'æ¨¡ç»„ç»„è£…', 'æ•´æœºæ¥æ°”', 'å‡ºè´§'],
        'wiring': ['æ¥çº¿-è¿”å·¥', 'ç”µæ§é…çº¿', 'æ•´æœºæ¥çº¿', 'é€šç”µé€šæ°”'],
        'mixed': ['é¡¹ç›®ç®¡ç†', 'é¢†æ–™', 'ä¸Šçº¿å‡†å¤‡', 'æ€»è£…', 'æ¸…æ´', 'æ‰“åŒ…']
      };

      const currentGroup = groups[sec] || [];

      // ç”Ÿæˆé€‰é¡¹
      currentGroup.forEach(opt => {
        contentOptions += `<option value="${opt}" ${s.content === opt ? 'selected' : ''}>${opt}</option>`;
      });

      // ä¸¥æ ¼æ£€æŸ¥ï¼šå¦‚æœæŸæ¡å†å²è®°å½•çš„å·¥è‰ºå®Œå…¨ä¸å±äºå½“å‰å¤§ç±»ï¼Œåˆ™è·³è¿‡
      if (s.content && !currentGroup.includes(s.content) && staffData) {
        console.warn(`[RefinedFilter] è·³è¿‡ä¸å±äº ${sec} çš„è®°å½•: ${s.worker_name} (${s.content})`);
        return;
      }

      const row = document.createElement('tr');
      row.id = rowId;
      row.innerHTML = `
                <td><input type="text" class="qe-name" value="${s.worker_name}" style="width:80px; padding:4px; border:1px solid #ddd; border-radius:4px; font-weight:700;"></td>
                <td>
                    <select class="qe-level" style="width:70px; padding:4px; border:1px solid #ddd; border-radius:4px;">
                        <option value="" ${!s.worker_level ? 'selected' : ''}></option>
                        <option value="å¤§å·¥" ${s.worker_level === 'å¤§å·¥' ? 'selected' : ''}>å¤§å·¥</option>
                        <option value="ä¸­å·¥" ${s.worker_level === 'ä¸­å·¥' ? 'selected' : ''}>ä¸­å·¥</option>
                        <option value="å°å·¥" ${s.worker_level === 'å°å·¥' ? 'selected' : ''}>å°å·¥</option>
                    </select>
                </td>
                <td>
                    <select class="qe-category" style="width:70px; padding:4px; border:1px solid #ddd; border-radius:4px;" 
                        onchange="handleQuickCategoryChange(this, '${rowId}')">
                        <option value="å¤–å" ${s.category === 'å¤–å' || !s.category ? 'selected' : ''}>å¤–å</option>
                        <option value="KIMD" ${s.category === 'KIMD' ? 'selected' : ''}>KIMD</option>
                    </select>
                </td>
                <td><input type="text" class="qe-supplier" value="${s.supplier}" style="width:90px; padding:4px; border:1px solid #ddd; border-radius:4px;"></td>
                <td>
                    <select class="qe-content" style="width:100px; padding:4px; border:1px solid #ddd; border-radius:4px;">
                        ${contentOptions}
                    </select>
                </td>
                <td><input type="time" class="qe-st" value="08:30" step="1800" onblur="ensureHalfHour(this)" style="padding:4px; border:1px solid #ddd; border-radius:4px; width:80px;" onchange="calcQuickHours('${rowId}')"></td>
                <td><input type="time" class="qe-et" step="1800" onblur="ensureHalfHour(this)" style="padding:4px; border:1px solid #ddd; border-radius:4px; width:80px;" onchange="calcQuickHours('${rowId}')"></td>
                <td><input type="text" class="qe-hours" value="ç­‰å¾…è®¡ç®—" readonly style="width:60px; border:none; background:transparent; font-weight:700; color:var(--primary);"></td>
                <td><input type="text" class="qe-remark" value="" placeholder="å¤‡æ³¨..." style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px;"></td>
                <td style="text-align:center;">
                    <button class="btn btn-primary qe-save-btn" style="padding:4px 12px; font-size:12px;" 
                        onclick="saveQuickEntryRecord(this, '${rowId}')">ä¿å­˜</button>
                    <button class="btn-tool" style="padding:4px 8px; font-size:11px; color:#ef4444; border:none; background:none;" onclick="this.closest('tr').remove()">åˆ é™¤</button>
                </td>
      `;
      tbody.appendChild(row);
      // åˆå§‹åŒ–çŠ¶æ€
      handleQuickCategoryChange(row.querySelector('.qe-category'), rowId);
    }

    function calcQuickHours(rowId) {
      const row = document.getElementById(rowId);
      const stValue = row.querySelector('.qe-st').value;
      const etValue = row.querySelector('.qe-et').value;
      const hoursEl = row.querySelector('.qe-hours');

      if (!etValue) {
        hoursEl.value = "ç­‰å¾…è®¡ç®—";
        return;
      }

      const [h1, m1] = stValue.split(':').map(Number);
      const [h2, m2] = etValue.split(':').map(Number);

      if (h1 > 11) {
        hoursEl.value = "ç‰¹æ®Š";
        return;
      }

      let rawHours = (h2 + m2 / 60) - (h1 + m1 / 60);
      if (rawHours < 0) rawHours += 24;

      const durationHourPart = Math.floor(rawHours + 0.0001);
      let finalHours = rawHours;
      if (durationHourPart <= 3) {
        finalHours = rawHours;
      } else if (durationHourPart >= 4 && durationHourPart <= 9) {
        finalHours = rawHours - 1;
      } else {
        finalHours = rawHours - 1.5;
      }
      hoursEl.value = finalHours.toFixed(1);
    }

    async function saveQuickEntryRecord(btn, rowId) {
      const row = document.getElementById(rowId);

      // ä»æ ‡é¢˜æ å…¨å±€åŒºåŸŸé‡‡é›†æ—¥æœŸå’Œå·¥å•ä¿¡æ¯
      const gDate = document.getElementById('quickEntryGlobalDate').value;
      const wo = document.getElementById('workOrder').value || document.getElementById('heroWorkOrder').textContent;
      const project = document.getElementById('heroProject').textContent || '-';

      // æ ¼å¼åŒ–æ—¥æœŸä¸º M/D
      let dateDisplay = '';
      if (gDate) {
        const parts = gDate.split('-');
        dateDisplay = parseInt(parts[1]) + '/' + parseInt(parts[2]);
      }

      // ä»è¾“å…¥åˆ—è¡¨å®æ—¶é‡‡é›†æ•°æ®
      const name = row.querySelector('.qe-name').value;
      const level = row.querySelector('.qe-level').value;
      const category = row.querySelector('.qe-category').value;
      const supplier = row.querySelector('.qe-supplier').value;
      const content = row.querySelector('.qe-content').value;
      const st = row.querySelector('.qe-st').value;
      const et = row.querySelector('.qe-et').value;
      const remark = row.querySelector('.qe-remark').value;
      const hoursText = row.querySelector('.qe-hours').value;

      if (!name.trim()) {
        alert("è¯·è¾“å…¥äººå‘˜å§“å");
        return;
      }
      if (!content) {
        alert(`è¯·é€‰æ‹©äººå‘˜ ${name} çš„å·¥æ—¶æŒ‚é ï¼ˆå·¥è‰ºï¼‰`);
        return;
      }

      if (category === 'å¤–å' && !level) {
        alert(`å¤–åäººå‘˜ ${name} å¿…é¡»é€‰æ‹©ç­‰çº§`);
        return;
      }

      if (!et) {
        alert(`è¯·å½•å…¥ ${name || 'æ–°è¡Œ'} çš„ä¸‹ç­æ—¶é—´`);
        return;
      }

      const hours = isNaN(parseFloat(hoursText)) ? 0 : parseFloat(hoursText);

      const payload = {
        work_date: dateDisplay,
        work_order: wo,
        project_name: project,
        worker_name: name,
        worker_level: level,
        start_time: st,
        end_time: et,
        hours: hours,
        supplier: supplier,
        content: content,
        category: category,
        remark1: remark,
        shift: 'ç™½ç­'
      };

      btn.disabled = true;
      btn.innerText = 'ä¿å­˜ä¸­...';

      try {
        const res = await fetch('/api/outsource-record', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const result = await res.json();
        if (result.success) {
          btn.innerText = 'âœ… å·²ä¿å­˜';
          btn.style.background = '#e2e8f0';
          btn.style.color = '#1e293b';
          btn.onclick = null;
          // æ ‡è®°è¡Œå·²å®Œæˆ
          row.style.opacity = '0.6';
        } else {
          alert('ä¿å­˜å¤±è´¥: ' + result.message);
          btn.disabled = false;
          btn.innerText = 'ä¿å­˜';
        }
      } catch (err) {
        alert('è¯·æ±‚å¼‚å¸¸: ' + err.message);
        btn.disabled = false;
        btn.innerText = 'ä¿å­˜';
      }
    }

    async function saveAllQuickEntries() {
      const btns = document.querySelectorAll('.qe-save-btn');
      for (const btn of btns) {
        if (!btn.disabled && btn.onclick) {
          await btn.onclick();
        }
      }
    }

    function closeQuickEntry() {
      document.getElementById('quickEntryPanel').classList.add('hidden');
    }
  </script>
</body>

</html>