<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©æ–™æ‰§è¡Œæƒ…å†µæŸ¥è¯¢</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #dbeafe;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --surface: #ffffff;
            --background: #f8fafc;
            --text-main: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius: 12px;
            --radius-sm: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--background);
            color: var(--text-main);
            min-height: 100vh;
            line-height: 1.5;
            padding-bottom: 80px;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 24px;
        }

        /* å¤´éƒ¨è®¾è®¡ */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding: 24px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .header-content h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-main);
            letter-spacing: -0.025em;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-content h1::before {
            content: '';
            display: block;
            width: 6px;
            height: 24px;
            background: var(--primary);
            border-radius: 3px;
        }

        .header-content p {
            color: var(--text-secondary);
            font-size: 14px;
            margin-left: 18px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        /* ç»Ÿä¸€æŒ‰é’®æ ·å¼ */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            border-radius: var(--radius-sm);
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            gap: 8px;
            white-space: nowrap;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            box-shadow: 0 6px 8px -1px rgba(37, 99, 235, 0.3);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: white;
            color: var(--text-main);
            border-color: var(--border);
        }

        .btn-secondary:hover {
            background: var(--background);
            border-color: #cbd5e1;
        }

        .btn-danger {
            background: #fee2e2;
            color: var(--danger);
            border-color: #fecaca;
        }

        .btn-danger:hover {
            background: #fecaca;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.2);
        }

        /* æœç´¢åŒºåŸŸå¡ç‰‡ */
        .search-section {
            background: var(--surface);
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }

        .search-wrapper {
            position: relative;
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .search-input-group {
            flex: 1;
            position: relative;
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
        }

        .search-input {
            width: 100%;
            padding: 14px 16px 14px 48px;
            font-size: 15px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            background: var(--background);
            transition: all 0.2s;
            color: var(--text-main);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px var(--primary-light);
        }

        /* åˆ—è¡¨åŒºåŸŸ */
        .list-section {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .list-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
        }

        .list-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-blue {
            background: var(--primary-light);
            color: var(--primary-dark);
        }

        .list-content {
            overflow-x: auto;
        }

        /* ç°ä»£åŒ–è¡¨æ ¼ */
        .modern-table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }

        .modern-table th {
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            background: white;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modern-table th.sortable {
            cursor: pointer;
            transition: color 0.2s;
        }

        .modern-table th.sortable:hover {
            color: var(--primary);
            background: #f8fafc;
        }

        .modern-table td {
            padding: 8px 16px;
            border-bottom: 1px solid var(--border);
            color: var(--text-main);
            vertical-align: middle;
            transition: all 0.2s;
        }

        .modern-table tr:last-child td {
            border-bottom: none;
        }

        .modern-table tr {
            transition: background-color 0.2s;
        }

        .modern-table tr:hover td {
            background-color: #f8fafc;
        }

        .modern-table tr.selected td {
            background-color: #eff6ff;
        }

        .modern-table tr.selected td:first-child {
            box-shadow: inset 4px 0 0 var(--primary);
        }

        /* å•å…ƒæ ¼å†…å®¹æ ·å¼ */
        .cell-main {
            font-weight: 600;
            color: var(--primary);
            font-family: 'Monaco', 'Consolas', monospace;
        }

        .cell-sub {
            font-size: 13px;
            color: var(--text-secondary);
            max-width: 300px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .cell-date {
            font-family: 'Monaco', 'Consolas', monospace;
            color: var(--text-secondary);
            font-size: 13px;
        }

        /* æ“ä½œæŒ‰é’®ç»„ */
        .action-group {
            display: flex;
            gap: 8px;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .modern-table tr:hover .action-group {
            opacity: 1;
        }

        .btn-icon {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
            background: white;
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .btn-icon:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: #eff6ff;
        }

        /* åº•éƒ¨å›ºå®šæ  */
        .bottom-bar {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(150%);
            background: var(--text-main);
            color: white;
            padding: 12px 24px;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            display: flex;
            align-items: center;
            gap: 24px;
            z-index: 50;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            min-width: 400px;
            justify-content: space-between;
        }

        .bottom-bar.visible {
            transform: translateX(-50%) translateY(0);
        }

        .selection-info {
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .selection-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .bottom-actions {
            display: flex;
            gap: 12px;
        }

        /* å¿«æ·å…¥å£ */
        .quick-links {
            margin-top: 32px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }

        .link-card {
            background: white;
            padding: 20px;
            border-radius: var(--radius);
            text-decoration: none;
            color: var(--text-main);
            border: 1px solid var(--border);
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .link-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
            border-color: var(--primary-light);
        }

        .link-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--primary);
        }

        .link-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* çŠ¶æ€ä¸æç¤º */
        .empty-state {
            padding: 80px 0;
            text-align: center;
            color: var(--text-muted);
        }

        .update-time {
            font-size: 13px;
            color: var(--text-muted);
            margin-left: auto;
        }

        /* å¤é€‰æ¡†ç¾åŒ– */
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <header class="page-header">
            <div class="header-content">
                <h1>ç‰©æ–™æ‰§è¡Œæƒ…å†µæŸ¥è¯¢</h1>
                <p>ä»ç”Ÿäº§æ’ç¨‹é€‰æ‹©å·¥å•ï¼Œå¿«é€ŸæŸ¥è¯¢ç‰©æ–™æ‰§è¡Œæ˜ç»†</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="window.location.href='index.html'"
                    style="margin-right: 8px;">
                    <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    è¿”å›ç»Ÿè®¡è¡¨ç›˜
                </button>
                <button class="btn btn-primary" onclick="startAutoSync()">
                    <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    è‡ªåŠ¨åŒæ­¥
                </button>
                <div style="position: relative; display: inline-block;">
                    <button class="btn btn-secondary" onclick="triggerImport()">
                        <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                        å¯¼å…¥Excel
                    </button>
                    <input type="file" id="import-excel" accept=".xlsx,.xls" style="display:none"
                        onchange="handleFileSelect(event)">
                </div>
                <button class="btn btn-secondary" onclick="forceRefresh()" title="æ¸…é™¤ç¼“å­˜å¹¶é‡æ–°åŠ è½½"
                    style="width: 40px; padding: 0;">
                    <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- æœç´¢ -->
        <div class="search-section">
            <div class="search-wrapper">
                <div class="search-input-group">
                    <svg class="search-icon" width="20" height="20" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <input type="text" class="search-input" id="searchInput" placeholder="è¾“å…¥å·¥å•å·ã€é¡¹ç›®åç§°æˆ–æ—¥æœŸè¿›è¡Œæœç´¢..."
                        onkeydown="if(event.key === 'Enter') handleQuery()">
                </div>
                <button class="btn btn-primary" style="padding: 14px 32px;" onclick="handleQuery()">æŸ¥è¯¢</button>
            </div>
        </div>

        <!-- åˆ—è¡¨ -->
        <div class="list-section">
            <div class="list-header">
                <div class="list-title">
                    å·¥å•åˆ—è¡¨
                    <span class="badge badge-blue" id="totalCount">å…± 0 ä¸ª</span>
                    <span class="badge badge-blue" id="filteredCount" style="display:none">ç­›é€‰å‡º 0 ä¸ª</span>
                    <span style="font-size: 12px; color: var(--text-muted); font-weight: normal;" id="displayCount">æ˜¾ç¤º 0
                        æ¡</span>
                </div>
                <span class="update-time" id="updateTime"></span>
            </div>

            <div class="list-content" id="listContent">
                <!-- åˆ—è¡¨å†…å®¹ç”± JS ç”Ÿæˆ -->
            </div>
        </div>

        <!-- å¿«æ·å…¥å£ -->
        <div class="quick-links">
            <a href="https://chajian.kimd.cn:9999/#/wms/produceManage/ppbomEntry?parameterStr=" target="_blank"
                class="link-card">
                <div class="link-title">ç”Ÿäº§æŠ•æ–™å•æ˜ç»†</div>
                <div class="link-desc">æŸ¥çœ‹è¯¦ç»†çš„ç”Ÿäº§ç‰©æ–™æŠ•æ”¾è®°å½•</div>
            </a>
            <a href="https://chajian.kimd.cn:9999/#/sc/work/productionScheduling?parameterStr=" target="_blank"
                class="link-card">
                <div class="link-title">ç”Ÿäº§æ’ç¨‹</div>
                <div class="link-desc">ç®¡ç†å’ŒæŸ¥çœ‹ç”Ÿäº§è®¡åˆ’ä¸è¿›åº¦</div>
            </a>
            <a href="https://chajian.kimd.cn:9999/#/wms/produceManage/icmo?parameterStr=" target="_blank"
                class="link-card">
                <div class="link-title">ç”Ÿäº§ä»»åŠ¡å•</div>
                <div class="link-desc">ç”Ÿäº§ä»»åŠ¡çš„è¯¦ç»†ä¿¡æ¯</div>
            </a>
            <a href="https://chajian.kimd.cn:9999/#/pmc/xm/sluggishMaterials?parameterStr=" target="_blank"
                class="link-card">
                <div class="link-title">å‘†æ»æ–™ä¿¡æ¯</div>
                <div class="link-desc">åº“å­˜ç§¯å‹ä¸å‘†æ»ç‰©æ–™åˆ†æ</div>
            </a>
        </div>
    </div>

    <!-- åº•éƒ¨æµ®åŠ¨æ“ä½œæ  -->
    <div class="bottom-bar" id="bottomBar">
        <div class="selection-info">
            <span>å·²é€‰æ‹©</span>
            <span class="selection-count" id="selectedCount">0</span>
            <span>ä¸ªå·¥å•</span>
        </div>
        <div class="bottom-actions">
            <button class="btn btn-secondary" style="border:none; background: rgba(255,255,255,0.1); color:white;"
                onclick="clearSelection()">å–æ¶ˆ</button>
            <button class="btn btn-success" onclick="batchQuery()">æ‰¹é‡æŸ¥è¯¢</button>
            <button class="btn btn-primary" onclick="batchDownload()">æ‰¹é‡ä¸‹è½½</button>
        </div>
    </div>


    <script>
        const STORAGE_KEY = 'work_order_data';
        const BASE_URL = 'https://chajian.kimd.cn:9999';
        const API_BASE_URL = 'http://localhost:3000';

        // åˆå§‹å·¥å•æ•°æ®ï¼ˆä»ç”Ÿäº§æ’ç¨‹é¡µé¢æå–ï¼ŒæŒ‰æ¥å•æ—¥æœŸå€’åºï¼‰
        const initialData = [
            { "workOrderNo": "", "taskNo": "R.F-005742601M105064", "projectName": "U66æ”¹TA003 ALT æ²»å…·æ”¹æœºåŒ…", "orderDate": "2026-01-27" },
            { "workOrderNo": "MO001692", "taskNo": "N.E-005662601M070055", "projectName": "F11 æ‰‡å¶æ¸…æ´è®¾å¤‡-MP 2#3#", "orderDate": "2026-01-26" },
            { "workOrderNo": "MO001693", "taskNo": "N.E-005662601M070056", "projectName": "F11 æ‰‡å¶æ¸…æ´è®¾å¤‡-MP 4#5#", "orderDate": "2026-01-26" },
            { "workOrderNo": "MO001691", "taskNo": "N.E-005662601M070057", "projectName": "F11 æ‰‡å¶æ¸…æ´è®¾å¤‡-NPI", "orderDate": "2026-01-26" },
            { "workOrderNo": "", "taskNo": "N.E-005732601M070052", "projectName": "F11 Face DownåŠŸèƒ½æµ‹è¯•åŠè‡ªåŠ¨æœº", "orderDate": "2026-01-26" },
            { "workOrderNo": "MO001637", "taskNo": "N.F-004692601M112042", "projectName": "Athena ALT æµ‹è¯•æ²»å…·", "orderDate": "2026-01-20" },
            { "workOrderNo": "MO001638", "taskNo": "N.F-004532601M112043", "projectName": "Apollo ALT æµ‹è¯•æ²»å…·", "orderDate": "2026-01-20" },
            { "workOrderNo": "MO001641", "taskNo": "N.F-001882601M144033", "projectName": "Roc FOP æµ‹è¯•æ²»å…·", "orderDate": "2026-01-16" },
            { "workOrderNo": "MO001639", "taskNo": "N.F-001892601M144036", "projectName": "Roc CGSæµ‹è¯•æ²»å…·", "orderDate": "2026-01-16" },
            { "workOrderNo": "MO001640", "taskNo": "N.F-001892601M144034", "projectName": "Roc CGSæµ‹è¯•æ²»å…·", "orderDate": "2026-01-16" },
            { "workOrderNo": "MO001621", "taskNo": "N.P-0003W2601M140031", "projectName": "æ¢é’ˆé’ˆæ¨¡å¯¿å‘½éªŒè¯æœº", "orderDate": "2026-01-15" },
            { "workOrderNo": "MO001600", "taskNo": "N.F-005122601M112029", "projectName": "TA003 ALT æµ‹è¯•æ²»å…·", "orderDate": "2026-01-14" },
            { "workOrderNo": "MO001583", "taskNo": "R.F-001862601M045018", "projectName": "Roc DT æµ‹è¯•æ²»å…·", "orderDate": "2026-01-12" },
            { "workOrderNo": "", "taskNo": "R.F-000272601M008007", "projectName": "2026ç ”å‘ä¸“ç”¨", "orderDate": "2026-01-04" },
            { "workOrderNo": "", "taskNo": "R.F-001802601M008008", "projectName": "2026å·¥å‚åˆ¶ç¨‹æ”¹å–„", "orderDate": "2026-01-04" },
            { "workOrderNo": "MO001572", "taskNo": "N.E-005662601M070001", "projectName": "F11 æ‰‡å¶æ¸…æ´è®¾å¤‡", "orderDate": "2026-01-04" },
            { "workOrderNo": "", "taskNo": "N.P-0003V2512M008062", "projectName": "KIMDæ¨¡ç»„æ ‡å‡†åŒ–", "orderDate": "2025-12-25" },
            { "workOrderNo": "MO001532", "taskNo": "N.E-004982512M112029", "projectName": "Athena åŠŸèƒ½æµ‹è¯•è®¾å¤‡", "orderDate": "2025-12-11" },
            { "workOrderNo": "MO001575", "taskNo": "N.E-004942512M112030", "projectName": "Apollo å…­é¢è§†è§‰æ£€æµ‹è®¾å¤‡", "orderDate": "2025-12-11" },
            { "workOrderNo": "MO001571", "taskNo": "N.P-0003U2512M008006", "projectName": "SmartMachine AIæ™ºèƒ½ç³»ç»Ÿ", "orderDate": "2025-12-02" },
            { "workOrderNo": "MO001471", "taskNo": "N.P-0003T2511M008066", "projectName": "T11 æ‘©æ“¦æµ‹è¯•æ²»å…·(éªŒè¯)", "orderDate": "2025-11-28" },
            { "workOrderNo": "MO001422", "taskNo": "N.E-005552511M070025", "projectName": "F11 çº¿åœˆç”µé˜»æµ‹è¯•è‡ªåŠ¨æœº", "orderDate": "2025-11-11" },
            { "workOrderNo": "MO001396", "taskNo": "R.E-004812510M070065", "projectName": "Apolloæ°”å¯†æµ‹è¯•è®¾å¤‡-å°æ¹¾", "orderDate": "2025-10-28" },
            { "workOrderNo": "MO001349", "taskNo": "R.F-005592510M070072", "projectName": "X3490 æ°”å¯†æ²»å…·(12x)", "orderDate": "2025-10-28" },
            { "workOrderNo": "MO001421", "taskNo": "N.E-005552510M070067", "projectName": "F11 çº¿åœˆç”µé˜»æµ‹è¯•è‡ªåŠ¨æœº", "orderDate": "2025-10-28" },
            { "workOrderNo": "MO001030", "taskNo": "N.E-004552508M070011", "projectName": "F75 OQC åŠŸèƒ½æµ‹è¯•æœº", "orderDate": "2025-08-07" },
            { "workOrderNo": "MO001031", "taskNo": "N.E-004572508M070012", "projectName": "F22 OQC åŠŸèƒ½æµ‹è¯•æœº", "orderDate": "2025-08-07" },
            { "workOrderNo": "MO000546", "taskNo": "N.F-005022505M008020", "projectName": "Apollo åŠŸèƒ½æµ‹è¯•æ²»å…·", "orderDate": "2025-05-14" },
            { "workOrderNo": "MO000627", "taskNo": "N.F-005032505M112021", "projectName": "Athena åŠŸèƒ½æµ‹è¯•æ²»å…·", "orderDate": "2025-05-14" },
            { "workOrderNo": "MO000558", "taskNo": "N.F-005042505M119018", "projectName": "T66 FCTåŠŸèƒ½æµ‹è¯•æ²»å…·", "orderDate": "2025-05-14" },
            { "workOrderNo": "MO000463", "taskNo": "R.F-004262504M070076", "projectName": "F11 ç”µæ± ä¾›ç”µæµ‹è¯•æ²»å…·", "orderDate": "2025-04-30" },
            { "workOrderNo": "MO000376", "taskNo": "N.P-0003N2504M112053", "projectName": "Apolloå¯†å°åœˆå‚å†…éªŒè¯å¹³å°", "orderDate": "2025-04-18" },
            { "workOrderNo": "MO000781", "taskNo": "R.E-003502503M070055", "projectName": "F1 RELåŠŸèƒ½æµ‹è¯•æœº", "orderDate": "2025-03-31" },
            { "workOrderNo": "MO000930", "taskNo": "R.E-003492503M070043", "projectName": "F1 OQCåŠŸèƒ½æµ‹è¯•æœº", "orderDate": "2025-03-27" },
            { "workOrderNo": "", "taskNo": "R.F-001802502M008034", "projectName": "å·¥å‚åˆ¶ç¨‹æ”¹å–„", "orderDate": "2025-02-19" },
            { "workOrderNo": "WORK006480", "taskNo": "R.F-000272501M070036", "projectName": "å‚å†…å®éªŒä¸“æ¡ˆ", "orderDate": "2025-01-13" }
        ];

        let workOrders = [];
        let filteredOrders = [];
        let selectedOrders = new Set();

        let refreshInterval = null;
        let currentSort = { field: 'orderDate', direction: 'desc' }; // é»˜è®¤æŒ‰æ—¥æœŸå€’åº

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            loadData();
            renderList();

            // æœç´¢æ¡†äº‹ä»¶
            document.getElementById('searchInput').addEventListener('input', function () {
                filterOrders(this.value);
            });

            // é¡µé¢æ˜¾ç¤ºæ—¶è‡ªåŠ¨æ£€æŸ¥å¹¶åŒæ­¥æ•°æ®
            autoSyncDataOnLoad();
        });

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŒæ­¥æ•°æ®
        async function autoSyncDataOnLoad() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                let shouldAutoSync = false;
                let hoursDiff = 0;

                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        const updateTime = new Date(parsed.updateTime);
                        const now = new Date();
                        const timeDiff = now - updateTime;
                        hoursDiff = timeDiff / (1000 * 60 * 60);

                        // å¦‚æœæ•°æ®è¶…è¿‡1å°æ—¶æœªæ›´æ–°ï¼Œè‡ªåŠ¨åŒæ­¥
                        shouldAutoSync = hoursDiff > 1;
                    } catch (e) {
                        // æ•°æ®è§£æå¤±è´¥ï¼Œéœ€è¦é‡æ–°åŒæ­¥
                        shouldAutoSync = true;
                    }
                } else {
                    // æ²¡æœ‰ç¼“å­˜æ•°æ®ï¼Œéœ€è¦åŒæ­¥
                    shouldAutoSync = true;
                }

                if (shouldAutoSync) {
                    console.log(`æ£€æµ‹åˆ°æ•°æ®éœ€è¦æ›´æ–° (${hoursDiff.toFixed(1)}å°æ—¶å‰æ›´æ–°)ï¼Œæ˜¾ç¤ºåŒæ­¥æç¤º...`);

                    // æ˜¾ç¤ºåŒæ­¥æç¤º
                    showSyncPrompt(hoursDiff);
                } else {
                    console.log('æ•°æ®è¾ƒæ–°ï¼Œæ— éœ€è‡ªåŠ¨åŒæ­¥');
                    // æ•°æ®è¾ƒæ–°ï¼Œæ˜¾ç¤ºæ­£å¸¸çŠ¶æ€
                    const updateTimeElement = document.getElementById('updateTime');
                    if (updateTimeElement) {
                        updateTimeElement.textContent += ` (æ•°æ®è¾ƒæ–°)`;
                        updateTimeElement.style.color = '#52c41a';
                    }
                }

            } catch (error) {
                console.error('è‡ªåŠ¨åŒæ­¥æ£€æŸ¥å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºåŒæ­¥æç¤º
        function showSyncPrompt(hoursDiff) {
            // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¾ç¤ºè¿‡æç¤º
            if (document.getElementById('syncPrompt')) return;

            // åˆ›å»ºæç¤ºå…ƒç´ 
            const promptDiv = document.createElement('div');
            promptDiv.id = 'syncPrompt';
            promptDiv.innerHTML = `
                <div style="
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #fffbe6;
                    border: 1px solid #ffe58f;
                    border-radius: 8px;
                    padding: 16px 20px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    max-width: 500px;
                    width: 90%;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <strong style="color: #ad8b00;">ğŸ”„ æ•°æ®éœ€è¦æ›´æ–°</strong>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                style="background: none; border: none; font-size: 18px; cursor: pointer; color: #999;">Ã—</button>
                    </div>
                    <p style="color: #ad8b00; margin: 8px 0; font-size: 14px;">
                        æ£€æµ‹åˆ°æ•°æ®å·² ${hoursDiff.toFixed(1)} å°æ—¶æœªæ›´æ–°ï¼Œå»ºè®®åŒæ­¥æœ€æ–°æ•°æ®
                    </p>
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <button onclick="showSyncInstructions()" 
                                style="flex: 1; padding: 8px 12px; background: #1890ff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                            å¦‚ä½•åŒæ­¥æ•°æ®
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                style="flex: 1; padding: 8px 12px; background: #f0f0f0; color: #666; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                            ç¨ååŒæ­¥
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(promptDiv);
        }

        // æ˜¾ç¤ºåŒæ­¥è¯´æ˜
        function showSyncInstructions() {
            const instructions = `
ğŸ“‹ æ•°æ®åŒæ­¥è¯´æ˜ï¼š

æ–¹æ³•ä¸€ï¼šä½¿ç”¨æ§åˆ¶å°ä»£ç ï¼ˆæ¨èï¼‰
1. æ‰“å¼€KIMDç³»ç»Ÿçš„ç”Ÿäº§æ’ç¨‹é¡µé¢
2. æŒ‰F12é”®æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·
3. ç‚¹å‡»"Console"ï¼ˆæ§åˆ¶å°ï¼‰æ ‡ç­¾é¡µ
4. å¤åˆ¶å¹¶ç²˜è´´ä»¥ä¸‹ä»£ç åˆ°æ§åˆ¶å°ï¼š

(() => {
  const rows = document.querySelectorAll('tbody tr');
  const data = [];
  const seen = new Set();
  
  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    if (cells.length > 5) {
      let workOrderNo = '';
      let taskNo = '';
      let projectName = '';
      let orderDate = '';
      
      for (let i = 0; i < cells.length; i++) {
        const txt = cells[i].textContent?.trim() || '';
        if (/^(WORK|MO)\\d+$/.test(txt)) workOrderNo = txt;
        else if (/^[RN]\\.[FEP]-\\d+/.test(txt)) taskNo = txt;
        else if (/^\\d{4}-\\d{2}-\\d{2}/.test(txt) && !orderDate) orderDate = txt;
        else if (txt.length > 3 && /[\\u4e00-\\u9fa5]/.test(txt) && 
                !/^\\d{2}\\.\\d{3}/.test(txt) && !/\\d{4}-\\d{2}-\\d{2}/.test(txt) && 
                txt.length < 50) {
          if (txt.includes('æµ‹è¯•') || txt.includes('è®¾å¤‡') || 
              txt.includes('æ²»å…·') || txt.includes('éªŒè¯')) projectName = txt;
          else if (!projectName) projectName = txt;
        }
      }
      
      if (taskNo && !seen.has(taskNo)) {
        seen.add(taskNo);
        data.push({
          workOrderNo: workOrderNo,
          taskNo: taskNo,
          projectName: projectName,
          orderDate: orderDate
        });
      }
    }
  });
  
  data.sort((a, b) => (b.orderDate || '').localeCompare(a.orderDate || ''));
  
  localStorage.setItem('work_order_data', JSON.stringify({
    data: data,
    updateTime: new Date().toISOString()
  }));
  
  console.log('åŒæ­¥å®Œæˆï¼Œå…±è·å–åˆ°', data.length, 'ä¸ªå·¥å•æ•°æ®');
  alert('âœ… åŒæ­¥æˆåŠŸï¼å…±è·å–åˆ°' + data.length + 'ä¸ªå·¥å•æ•°æ®ï¼Œè¯·è¿”å›ç‰©æ–™æŸ¥è¯¢å·¥å…·é¡µé¢æŸ¥çœ‹ã€‚');
})();

5. æŒ‰å›è½¦é”®æ‰§è¡Œä»£ç 
6. åŒæ­¥å®Œæˆååˆ·æ–°æœ¬é¡µé¢æŸ¥çœ‹æœ€æ–°æ•°æ®

æ–¹æ³•äºŒï¼šæ‰“å¼€ç”Ÿäº§æ’ç¨‹é¡µé¢
ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç›´æ¥æ‰“å¼€ç”Ÿäº§æ’ç¨‹é¡µé¢ï¼š
            `;

            alert(instructions);

            // æ‰“å¼€ç”Ÿäº§æ’ç¨‹é¡µé¢
            window.open(`${BASE_URL}/#/sc/work/productionScheduling?parameterStr=`, '_blank');
        }

        // å¼€å§‹è‡ªåŠ¨åˆ·æ–°æ£€æŸ¥
        function startAutoRefresh() {
            if (refreshInterval) return;

            refreshInterval = setInterval(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        const updateTime = new Date(parsed.updateTime);
                        const now = new Date();
                        const hoursDiff = (now - updateTime) / (1000 * 60 * 60);

                        // å¦‚æœæ•°æ®è¶…è¿‡4å°æ—¶æœªæ›´æ–°ï¼Œåœ¨é¡µé¢å¯è§æ—¶æç¤º
                        if (hoursDiff > 4 && !document.hidden) {
                            console.log('æ£€æµ‹åˆ°æ•°æ®éœ€è¦æ›´æ–°');
                            // å¯ä»¥é€‰æ‹©è‡ªåŠ¨æç¤ºç”¨æˆ·æˆ–é™é»˜å¤„ç†
                        }
                    } catch (e) {
                        console.log('æ•°æ®æ£€æŸ¥å‡ºé”™:', e);
                    }
                }
            }, 30 * 60 * 1000); // 30åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
        }

        // åœæ­¢è‡ªåŠ¨åˆ·æ–°æ£€æŸ¥
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        // æ£€æŸ¥æ•°æ®æ–°é²œåº¦
        function checkDataFreshness() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    const updateTime = new Date(parsed.updateTime);
                    const now = new Date();
                    const timeDiff = now - updateTime;
                    const hoursDiff = timeDiff / (1000 * 60 * 60);

                    // æ›´æ–°æ˜¾ç¤ºçš„æ—¶é—´ä¿¡æ¯
                    updateUpdateTimeDisplay(parsed.updateTime);

                    // å¦‚æœæ•°æ®è¶…è¿‡2å°æ—¶æœªæ›´æ–°ï¼Œæç¤ºç”¨æˆ·
                    if (hoursDiff > 2) {
                        setTimeout(() => {
                            if (confirm(`æ£€æµ‹åˆ°æ•°æ®å·²è¶…è¿‡${Math.floor(hoursDiff)}å°æ—¶æœªæ›´æ–°ï¼Œå»ºè®®åŒæ­¥æœ€æ–°æ•°æ®ã€‚\n\næ˜¯å¦ç«‹å³åŒæ­¥ï¼Ÿ`)) {
                                refreshData();
                            }
                        }, 1000);
                    }
                } catch (e) {
                    // æ•°æ®è§£æå¤±è´¥ï¼Œå»ºè®®é‡æ–°åŒæ­¥
                    setTimeout(() => {
                        if (confirm('æ£€æµ‹åˆ°æ•°æ®å¼‚å¸¸ï¼Œå»ºè®®é‡æ–°åŒæ­¥æ•°æ®ã€‚\n\næ˜¯å¦ç«‹å³åŒæ­¥ï¼Ÿ')) {
                            refreshData();
                        }
                    }, 1000);
                }
            }
        }

        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
        function updateUpdateTimeDisplay(updateTime, source, sourceFile) {
            const timeElement = document.getElementById('updateTime');
            if (timeElement && updateTime) {
                const time = new Date(updateTime);
                const now = new Date();
                const diffMs = now - time;
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

                let timeText = `æœ€åæ›´æ–°: ${time.toLocaleString('zh-CN')}`;

                // æ·»åŠ æ¥æºæ ‡è¯†
                let sourceText = '';
                if (source === 'server') {
                    sourceText = ' <span style="background:#52c41a;color:white;padding:2px 6px;border-radius:4px;font-size:11px;">æ¥è‡ªæœ¬åœ°æœåŠ¡å™¨</span>';
                    if (sourceFile) {
                        sourceText += ` <span style="color:#666;font-size:11px;margin-left:5px;">ğŸ“ ${sourceFile}</span>`;
                    }
                } else if (source === 'local') {
                    sourceText = ' <span style="background:#faad14;color:white;padding:2px 6px;border-radius:4px;font-size:11px;">æ¥è‡ªæµè§ˆå™¨ç¼“å­˜</span>';
                }

                if (diffHours < 1 && diffMinutes > 0) {
                    timeText += ` (${diffMinutes}åˆ†é’Ÿå‰)`;
                } else if (diffHours >= 1 && diffHours < 24) {
                    timeText += ` (${diffHours}å°æ—¶å‰)`;
                } else if (diffHours >= 24) {
                    const diffDays = Math.floor(diffHours / 24);
                    timeText += ` (${diffDays}å¤©å‰)`;
                }

                timeElement.innerHTML = timeText + sourceText;

                // æ ¹æ®æ•°æ®æ–°é²œåº¦æ”¹å˜æ˜¾ç¤ºé¢œè‰²
                if (diffHours > 24) {
                    timeElement.style.color = '#ff4d4f'; // çº¢è‰² - å¾ˆæ—§
                } else if (diffHours > 6) {
                    timeElement.style.color = '#faad14'; // æ©™è‰² - è¾ƒæ—§
                } else {
                    timeElement.style.color = '#52c41a'; // ç»¿è‰² - è¾ƒæ–°
                }
            } else if (timeElement) {
                timeElement.textContent = 'æš‚æ— æ›´æ–°è®°å½•';
            }
        }

        // åŠ è½½æ•°æ®
        async function loadData() {
            // ä¼˜å…ˆå°è¯•ä»æœ¬åœ°æœåŠ¡å™¨è·å–æ•°æ®
            try {
                const response = await fetch(`${API_BASE_URL}/api/work-orders`);
                const result = await response.json();

                if (result.success && result.data && result.data.length > 0) {
                    console.log('ä»æœ¬åœ°æœåŠ¡å™¨åŠ è½½æ•°æ®æˆåŠŸ');
                    workOrders = result.data;
                    workOrders = result.data;
                    // æ›´æ–°æ—¶é—´æ˜¾ç¤ºï¼Œå¹¶æ ‡è®°æ¥æº
                    updateUpdateTimeDisplay(result.updateTime, 'server', result.sourceFile);

                    // ç‰¹æ®Šå¤„ç†ï¼šä¿å­˜ä¸€ä»½å‰¯æœ¬åˆ°localStorageä½œä¸ºå¤‡ç”¨
                    localStorage.setItem(STORAGE_KEY, JSON.stringify({
                        data: workOrders,
                        updateTime: result.updateTime
                    }));
                } else {
                    throw new Error('æœåŠ¡å™¨æ— æ•°æ®');
                }
            } catch (err) {
                console.log('æ— æ³•è¿æ¥æœåŠ¡å™¨æˆ–æ— æ•°æ®ï¼Œé™çº§ä½¿ç”¨æœ¬åœ°ç¼“å­˜:', err);

                // é™çº§é€»è¾‘ï¼šè¯»å– localStorage
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        workOrders = parsed.data || initialData;
                        updateUpdateTimeDisplay(parsed.updateTime, 'local');
                    } catch (e) {
                        workOrders = initialData;
                        updateUpdateTimeDisplay(null);
                    }
                } else {
                    workOrders = initialData;
                    saveData(); // ä¿å­˜åˆå§‹æ•°æ®
                    updateUpdateTimeDisplay(new Date().toISOString(), 'init');
                }
            }

            filteredOrders = [...workOrders];
            updateStats();
            sortFilteredOrders(); // Apply default sort
            renderList(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
        }

        // ä¿å­˜æ•°æ® (ä»…ç”¨äºæœ¬åœ°å˜æ›´ï¼Œå®é™…ä¸Šä¸»è¦æ˜¯åªè¯»)
        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify({
                data: workOrders,
                updateTime: new Date().toISOString()
            }));
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            document.getElementById('totalCount').textContent = `å…± ${workOrders.length} ä¸ªå·¥å•`;
            document.getElementById('displayCount').textContent = `æ˜¾ç¤º ${filteredOrders.length} æ¡`;

            const filteredCountEl = document.getElementById('filteredCount');
            if (filteredOrders.length !== workOrders.length) {
                filteredCountEl.textContent = `ç­›é€‰å‡º ${filteredOrders.length} ä¸ª`;
                filteredCountEl.style.display = 'inline';
            } else {
                filteredCountEl.style.display = 'none';
            }
        }

        // ç­›é€‰å·¥å•
        function filterOrders(keyword) {
            keyword = keyword.toLowerCase().trim();
            if (!keyword) {
                filteredOrders = [...workOrders];
            } else {
                filteredOrders = workOrders.filter(order =>
                    (order.workOrderNo && order.workOrderNo.toLowerCase().includes(keyword)) ||
                    order.projectName.toLowerCase().includes(keyword) ||
                    (order.taskNo && order.taskNo.toLowerCase().includes(keyword)) ||
                    (order.orderDate && order.orderDate.includes(keyword))
                );
            }
            // ç­›é€‰åé‡æ–°æ’åº
            sortFilteredOrders();
            renderList();
            updateStats();
        }

        // æ’åºé€»è¾‘
        function sortOrders(field) {
            if (currentSort.field === field) {
                // åˆ‡æ¢æ–¹å‘
                currentSort.direction = currentSort.direction === 'desc' ? 'asc' : 'desc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'desc'; // æ–°å­—æ®µé»˜è®¤å€’åº
            }
            sortFilteredOrders();
            renderList();
        }

        function sortFilteredOrders() {
            const { field, direction } = currentSort;
            filteredOrders.sort((a, b) => {
                const valA = (a[field] || '').toString();
                const valB = (b[field] || '').toString();

                if (direction === 'asc') {
                    return valA.localeCompare(valB, 'zh-CN');
                } else {
                    return valB.localeCompare(valA, 'zh-CN');
                }
            });
        }

        // æ¸²æŸ“åˆ—è¡¨
        function renderList() {
            const container = document.getElementById('listContent');

            if (filteredOrders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg width="64" height="64" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="margin-bottom:16px; color:var(--text-muted); opacity:0.5;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                        </svg>
                        <p>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å·¥å•</p>
                    </div>
                `;
                return;
            }

            const isAllSelected = filteredOrders.length > 0 && filteredOrders.every(o => selectedOrders.has(o.taskNo));

            container.innerHTML = `
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th width="60" style="text-align:center">
                                <input type="checkbox" onclick="toggleSelectAll(this)" ${isAllSelected ? 'checked' : ''}>
                            </th>
                            <th class="sortable" onclick="sortOrders('workOrderNo')">
                                å·¥å•ä¿¡æ¯ ${currentSort.field === 'workOrderNo' ? (currentSort.direction === 'desc' ? 'â†“' : 'â†‘') : ''}
                            </th>
                            <th class="sortable" onclick="sortOrders('projectName')">
                                é¡¹ç›®åç§° ${currentSort.field === 'projectName' ? (currentSort.direction === 'desc' ? 'â†“' : 'â†‘') : ''}
                            </th>
                            <th class="sortable" onclick="sortOrders('orderDate')">
                                æ¥å•æ—¶é—´ ${currentSort.field === 'orderDate' ? (currentSort.direction === 'desc' ? 'â†“' : 'â†‘') : ''}
                            </th>
                            <th class="sortable" onclick="sortOrders('orderQty')">
                                å·¥å•æ•°é‡ ${currentSort.field === 'orderQty' ? (currentSort.direction === 'desc' ? 'â†“' : 'â†‘') : ''}
                            </th>
                            <th width="160">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredOrders.map(order => `
                            <tr class="${selectedOrders.has(order.taskNo) ? 'selected' : ''}" onclick="toggleSelect('${order.taskNo}')">
                                <td style="text-align: center;">
                                    <input type="checkbox" 
                                           ${selectedOrders.has(order.taskNo) ? 'checked' : ''}
                                           onclick="event.stopPropagation(); toggleSelect('${order.taskNo}', this.checked)">
                                </td>
                                <td>
                                    <div class="cell-main">${order.workOrderNo}</div>
                                </td>
                                <td>
                                    <div class="cell-main" style="color:var(--text-main); font-size:14px; font-weight:500;" title="${order.projectName}">${order.projectName}</div>
                                </td>
                                <td>
                                    <div class="cell-date">${order.orderDate || '-'}</div>
                                </td>
                                <td>
                                    <div class="cell-main" style="color:var(--text-main); text-align:right; font-family:inherit;">${order.orderQty || '-'}</div>
                                </td>
                                <td>
                                    <div class="action-group">
                                        <button class="btn-icon" title="æŠ•æ–™æ˜ç»†" onclick="event.stopPropagation(); queryMaterial('${order.taskNo}')">
                                            æŠ•æ–™
                                        </button>
                                        <button class="btn-icon" title="åˆ°æ–™æ˜ç»†" onclick="event.stopPropagation(); queryBarcodeMaterial('${order.taskNo}')">
                                            åˆ°æ–™
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // å…¨é€‰/å–æ¶ˆå…¨é€‰
        function toggleSelectAll(checkbox) {
            if (checkbox.checked) {
                filteredOrders.forEach(order => selectedOrders.add(order.taskNo));
            } else {
                selectedOrders.clear();
            }
            updateBottomBar();
            renderList();
        }

        // åˆ‡æ¢é€‰æ‹©
        function toggleSelect(taskNo, checked) {
            if (checked === undefined) {
                checked = !selectedOrders.has(taskNo);
            }

            if (checked) {
                selectedOrders.add(taskNo);
            } else {
                selectedOrders.delete(taskNo);
            }

            updateBottomBar();
            renderList();
        }

        // æ›´æ–°åº•éƒ¨æ 
        function updateBottomBar() {
            const bottomBar = document.getElementById('bottomBar');
            const count = selectedOrders.size;

            if (count > 0) {
                bottomBar.classList.add('visible'); // Show
                document.getElementById('selectedCount').textContent = count;
            } else {
                bottomBar.classList.remove('visible'); // Hide
            }
        }

        // æ¸…é™¤é€‰æ‹©
        function clearSelection() {
            selectedOrders.clear();
            updateBottomBar();
            renderList();
        }

        // è·å–æœ‰æ•ˆçš„å·¥å•å·ï¼ˆä¼˜å…ˆ N. æˆ– R. å¼€å¤´ï¼‰
        function getValidWorkOrderNo(order) {
            if (!order) return '';
            // æ£€æŸ¥ workOrderNo æ˜¯å¦ç¬¦åˆ N. æˆ– R. å¼€å¤´
            if (order.workOrderNo && /^[NR]\./.test(order.workOrderNo)) return order.workOrderNo;
            // æ£€æŸ¥ taskNo æ˜¯å¦ç¬¦åˆ
            if (order.taskNo && /^[NR]\./.test(order.taskNo)) return order.taskNo;
            // å¦‚æœéƒ½ä¸ç¬¦åˆï¼Œä¼˜å…ˆè¿”å› workOrderNoï¼Œå…¶æ¬¡ taskNo
            return order.workOrderNo || order.taskNo;
        }

        // æŸ¥è¯¢ç‰©æ–™æ˜ç»†ï¼ˆå•ä¸ªï¼‰
        function queryMaterial(identifier) {
            const order = workOrders.find(o => o.taskNo === identifier || o.workOrderNo === identifier);
            const targetNo = getValidWorkOrderNo(order) || identifier;

            const url = `${BASE_URL}/#/wms/produceManage/ppbomEntry?parameterStr=`;
            window.open(url, '_blank');

            setTimeout(() => {
                alert(`è¯·åœ¨æ‰“å¼€çš„é¡µé¢ä¸­ï¼š\n\n1. åœ¨"å·¥å•å·"è¾“å…¥æ¡†ä¸­è¾“å…¥: ${targetNo}\n2. ç‚¹å‡»"è¿‡æ»¤"æŒ‰é’®æŸ¥è¯¢`);
            }, 500);
        }

        // ä¸ºäº†èƒ½ç»™ç»Ÿè®¡é¡µé¢å‘æ¶ˆæ¯ï¼ŒæŠŠçª—å£å­˜ä¸‹æ¥
        let currentStatsWindow = null;
        let currentKimdWindow = null; // ç”¨äºå­˜å‚¨ KIMD å¯¼å‡ºé¡µé¢å¥æŸ„ï¼Œå®ç°è‡ªåŠ¨å…³é—­

        // æŸ¥è¯¢æ¡ç ç³»ç»Ÿç‰©æ–™æ‰§è¡Œæƒ…å†µæ˜ç»† (åˆ°æ–™æ˜ç»†)
        function queryBarcodeMaterial(identifier) {
            // æŸ¥æ‰¾å¯¹åº”çš„å·¥å•ä»¥è·å–é¡¹ç›®åç§°
            const order = workOrders.find(o => o.workOrderNo === identifier || o.taskNo === identifier);
            const projectName = order ? order.projectName : '';
            const targetNo = getValidWorkOrderNo(order) || identifier;

            // ç„¦ç‚¹é˜²æŠ¢å¤ºç­–ç•¥ï¼š
            // 1. åŒæ­¥æ‰“å¼€ç»Ÿè®¡é¡µé¢ï¼ˆä¼šè¢«ç«‹åˆ»æ¨å…¥åå°ï¼‰
            const since = Date.now();
            const statsUrl = `http://localhost:3000/index.html?workOrder=${encodeURIComponent(targetNo)}&project=${encodeURIComponent(projectName)}&since=${since}`;
            currentStatsWindow = window.open(statsUrl, '_blank');

            // 2. å»¶è¿Ÿ 100ms å¼€å¯ KIMD å¯¼å‡ºé¡µé¢ï¼Œå¹¶é€šè¿‡æ‰§è¡Œ focus() å¼ºè¡Œå°†å…¶æ‹‰å›å‰å°æ¿€æ´»ç¯¡æ”¹çŒ´
            setTimeout(() => {
                const kimdUrl = `${BASE_URL}/#/wms/reportManage/materialProgres?auto=true&workOrder=${encodeURIComponent(targetNo)}`;
                currentKimdWindow = window.open(kimdUrl, `kimd_export_${targetNo}`);
                if (currentKimdWindow) {
                    currentKimdWindow.focus(); // å¼ºåˆ¶ææƒ
                }
            }, 100);
        }

        // æ¥æ”¶æ¥è‡ª KIMD Tampermonkey çš„æ¶ˆæ¯ï¼ˆä¸‹è½½è§¦å‘æˆåŠŸï¼‰å’Œæ¥è‡ªç»Ÿè®¡é¡µé¢çš„æ¶ˆæ¯
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'kimd-download-triggered') {
                // å°†æ¶ˆæ¯è½¬å‘ç»™å½“å‰æ‰“å¼€çš„ stats çª—å£ï¼Œè®©å®ƒå¼€å§‹ç›‘æ§æ–°å¯¼å‡ºçš„ excel æ–‡ä»¶
                if (currentStatsWindow && !currentStatsWindow.closed) {
                    currentStatsWindow.postMessage({
                        type: 'kimd-excel-wait',
                        payload: event.data.payload
                    }, '*');
                }
            } else if (event.data && event.data.type === 'STATS_BATCH_COMPLETED') {
                // æ”¶åˆ°ç»Ÿè®¡é¡µé¢ï¼ˆindex.htmlï¼‰å®Œæˆæ¸²æŸ“çš„æ¶ˆæ¯ï¼Œè‡ªåŠ¨å…³é—­æ­¤æ—¶æ‰“å¼€çš„ KIMD é¡µé¢
                if (currentKimdWindow && !currentKimdWindow.closed) {
                    try {
                        currentKimdWindow.close();
                        currentKimdWindow = null;
                        console.log('å·²è‡ªåŠ¨å…³é—­ KIMD å¯¼å‡ºçª—å£');
                    } catch (e) {
                        console.error('å…³é—­ KIMD çª—å£å¤±è´¥', e);
                    }
                }
            }
        });

        // æ‰¹é‡æŸ¥è¯¢
        function batchQuery() {
            if (selectedOrders.size === 0) return;

            // è·å–é€‰ä¸­çš„å·¥å•å·
            const orders = [];
            selectedOrders.forEach(taskNo => {
                const order = workOrders.find(o => o.taskNo === taskNo);
                if (order) {
                    orders.push(getValidWorkOrderNo(order));
                }
            });

            const url = `${BASE_URL}/#/wms/produceManage/ppbomEntry?parameterStr=`;
            window.open(url, '_blank');

            setTimeout(() => {
                alert(`è¯·åœ¨æ‰“å¼€çš„é¡µé¢ä¸­è¿‡æ»¤ä»¥ä¸‹å·¥å•ï¼š\n\n${orders.join('\n')}\n\næç¤ºï¼šå¯ä»¥åœ¨"å·¥å•å·"è¾“å…¥æ¡†ä¸­é€ä¸ªè¾“å…¥æŸ¥è¯¢`);
            }, 500);
        }

        // æ‰¹é‡ä¸‹è½½åˆ°æ–™æ˜ç»† (é¡ºåºæ‰§è¡Œ)
        async function batchDownload() {
            if (selectedOrders.size === 0) return;

            // è·å–é€‰ä¸­çš„å·¥å•
            const orders = [];
            selectedOrders.forEach(taskNo => {
                const order = workOrders.find(o => o.taskNo === taskNo);
                if (order) {
                    orders.push(order);
                }
            });

            if (!confirm(`å³å°†ä¸º ${orders.length} ä¸ªå·¥å•æ‰§è¡Œé¡ºåºä¸‹è½½ã€‚\n\nâš ï¸ è¯·æ³¨æ„ï¼š\n1. å°†é€ä¸ªæ‰“å¼€æ–°çª—å£ï¼Œå‰ä¸€ä¸ªå®Œæˆåä¼šè‡ªåŠ¨å…³é—­å¹¶å¼€å§‹ä¸‹ä¸€ä¸ªã€‚\n2. è¯·ä¿æŒæœ¬é¡µé¢å¼€å¯ï¼Œä¸è¦å…³é—­ã€‚\n\næ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
                return;
            }

            const statusDiv = document.createElement('div');
            statusDiv.style.cssText = 'position:fixed;top:20px;right:20px;background:rgba(0,0,0,0.8);color:white;padding:15px;border-radius:8px;z-index:9999;font-size:14px;';
            statusDiv.innerHTML = `æ­£åœ¨åˆå§‹åŒ–æ‰¹é‡ä»»åŠ¡...`;
            document.body.appendChild(statusDiv);

            const updateStatus = (msg) => statusDiv.textContent = msg;

            // ç›‘å¬å™¨
            let resolveCurrent = null;
            const messageHandler = (event) => {
                if (event.data && event.data.type === 'STATS_BATCH_COMPLETED') {
                    if (resolveCurrent) resolveCurrent(true);
                }
            };
            window.addEventListener('message', messageHandler);

            for (let i = 0; i < orders.length; i++) {
                const order = orders[i];
                const targetNo = getValidWorkOrderNo(order);
                const progress = `[${i + 1}/${orders.length}]`;

                updateStatus(`${progress} æ­£åœ¨å¤„ç†: ${targetNo}...`);
                console.log(`${progress} Start: ${targetNo}`);

                const url = `http://localhost:3000/index.html?workOrder=${encodeURIComponent(targetNo)}&project=${encodeURIComponent(order.projectName)}&auto=true`;

                // æ‰“å¼€çª—å£
                const win = window.open(url, `batch_dl_${targetNo}`);

                // ç­‰å¾…å®Œæˆæˆ–è¶…æ—¶ (è¶…æ—¶è®¾ç½®ä¸º 150 ç§’ï¼Œç»™äºˆå……è¶³æ—¶é—´)
                const success = await new Promise(resolve => {
                    resolveCurrent = resolve;
                    // è¶…æ—¶è®¡æ—¶å™¨
                    setTimeout(() => {
                        resolve(false);
                    }, 150000);
                });

                if (success) {
                    console.log(`${progress} Success: ${targetNo}`);
                    updateStatus(`${progress} å®Œæˆ: ${targetNo}`);
                } else {
                    console.warn(`${progress} Timeout: ${targetNo}`);
                    updateStatus(`${progress} è¶…æ—¶ (å·²è·³è¿‡): ${targetNo}`);
                }

                // ç¨å¾®ç­‰å¾…ä¸€ä¸‹å†å¼€ä¸‹ä¸€ä¸ªï¼Œç»™æµè§ˆå™¨å–˜æ¯æ—¶é—´
                await new Promise(r => setTimeout(r, 2000));
            }

            window.removeEventListener('message', messageHandler);
            updateStatus(`âœ… æ‰¹é‡ä»»åŠ¡ç»“æŸï¼å…±å¤„ç† ${orders.length} ä¸ªã€‚`);
            setTimeout(() => document.body.removeChild(statusDiv), 5000);
            alert(`æ‰¹é‡ä»»åŠ¡å·²å®Œæˆï¼`);
        }

        // å¤„ç†æŸ¥è¯¢
        function handleQuery() {
            const input = document.getElementById('searchInput');
            const keyword = input.value.trim();

            if (!keyword) {
                alert('è¯·è¾“å…¥å·¥å•å·æˆ–é¡¹ç›®åç§°');
                return;
            }

            // å°è¯•åœ¨ç°æœ‰æ•°æ®ä¸­æŸ¥æ‰¾ï¼ˆä¸ºäº†è·å–é¡¹ç›®åç§°ï¼‰
            const order = workOrders.find(o =>
                (o.workOrderNo && o.workOrderNo.toLowerCase() === keyword.toLowerCase()) ||
                (o.taskNo && o.taskNo.toLowerCase() === keyword.toLowerCase())
            );

            // å¦‚æœæ‰¾åˆ°äº†ï¼Œä½¿ç”¨å®Œæ•´çš„å·¥å•ä¿¡æ¯ï¼ˆåŒ…å«é¡¹ç›®åç§°ï¼‰
            // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œç›´æ¥ä½¿ç”¨è¾“å…¥å€¼ä½œä¸ºå·¥å•å·å»æŸ¥è¯¢
            const identifier = order ? (order.taskNo || order.workOrderNo) : keyword;

            // è°ƒç”¨â€œåˆ°æ–™æ˜ç»†â€çš„é€»è¾‘
            queryBarcodeMaterial(identifier);
        }

        // æ¸…ç©ºæœç´¢
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            filterOrders('');
        }

        // åˆ·æ–°æ•°æ®ï¼ˆæ™ºèƒ½åŒæ­¥ï¼‰
        function refreshData() {
            // é¦–å…ˆæä¾›ä½¿ç”¨ä¹¦ç­¾çš„ç®€å•æ–¹å¼
            const useBookmarklet = confirm(`æ˜¯å¦ä½¿ç”¨ä¹¦ç­¾å·¥å…·åŒæ­¥æ•°æ®ï¼Ÿ(æ¨è)
            
ä¼˜åŠ¿ï¼š
âœ… ç®€å•å¯é 
âœ… ä¸€é”®åŒæ­¥
âœ… é¿å…æµè§ˆå™¨å®‰å…¨é™åˆ¶

ç‚¹å‡»"ç¡®å®š"ä½¿ç”¨ä¹¦ç­¾åŒæ­¥
ç‚¹å‡»"å–æ¶ˆ"ä½¿ç”¨è‡ªåŠ¨å°è¯•`);

            if (useBookmarklet) {
                createAndUseBookmarklet();
                return;
            }

            // å¦‚æœç”¨æˆ·é€‰æ‹©è‡ªåŠ¨åŒæ­¥ï¼Œåˆ™å°è¯•iframeæ–¹å¼
            performAutomaticSync();
        }

        // åˆ›å»ºå¹¶ä½¿ç”¨ä¹¦ç­¾å·¥å…· (å·²åºŸå¼ƒï¼Œæ”¹ä¸ºæç¤ºä½¿ç”¨è„šæœ¬)
        function createAndUseBookmarklet() {
            const instructions = `
ğŸ“‹ æ•°æ®åŒæ­¥è¯´æ˜ï¼š
æˆ‘ä»¬å·²ç»å‡çº§äº†åŒæ­¥æ–¹å¼ï¼

1. è¯·ç¡®ä¿æ‚¨å·²å®‰è£… "KIMD ç”Ÿäº§æ’ç¨‹æ•°æ®åŒæ­¥åŠ©æ‰‹" è„šæœ¬
   (è¯¥è„šæœ¬ä¼šè‡ªåŠ¨åœ¨ KIMD é¡µé¢å³ä¸‹è§’æ·»åŠ åŒæ­¥æŒ‰é’®)

2. æ“ä½œæ­¥éª¤ï¼š
   â€¢ ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‰“å¼€ç”Ÿäº§æ’ç¨‹é¡µé¢
   â€¢ ç‚¹å‡»é¡µé¢å³ä¸‹è§’çš„ "ğŸ”„ åŒæ­¥åˆ°æœ¬åœ°å·¥å…·" æŒ‰é’®
   â€¢ çœ‹åˆ°æˆåŠŸæç¤ºåï¼Œè¿”å›æœ¬é¡µé¢åˆ·æ–°å³å¯

ä¸éœ€è¦å†å¤åˆ¶ç²˜è´´ä»£ç äº†ï¼
            `;

            alert(instructions);

            // æä¾›å¿«é€Ÿæ‰“å¼€ç”Ÿäº§æ’ç¨‹é¡µé¢çš„é€‰é¡¹
            if (confirm('æ˜¯å¦ç°åœ¨æ‰“å¼€ç”Ÿäº§æ’ç¨‹é¡µé¢ï¼Ÿ')) {
                window.open(`${BASE_URL}/#/sc/work/productionScheduling?parameterStr=`, '_blank');
            }
        }

        // æ‰§è¡Œè‡ªåŠ¨åŒæ­¥å°è¯•
        async function performAutomaticSync() {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const refreshBtn = document.querySelector('[onclick="refreshData()"]');
            const originalText = refreshBtn.textContent;
            refreshBtn.textContent = 'åŒæ­¥ä¸­...';
            refreshBtn.disabled = true;

            try {
                // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒæ‰€éœ€åŠŸèƒ½
                if (!window.fetch) {
                    alert('æµè§ˆå™¨ä¸æ”¯æŒfetch APIï¼Œè¯·ä½¿ç”¨ç°ä»£æµè§ˆå™¨ï¼ˆå¦‚Chromeã€Firefoxã€Safariç­‰ï¼‰');
                    return;
                }

                // æç¤ºç”¨æˆ·éœ€è¦åœ¨KIMDç³»ç»Ÿä¸­ç™»å½•
                const userConfirmed = confirm('å³å°†å¼€å§‹åŒæ­¥ç”Ÿäº§æ’ç¨‹æ•°æ®ã€‚\n\nè¯·ç¡®ä¿ï¼š\n1. æ‚¨å·²åœ¨KIMDç³»ç»Ÿä¸­ç™»å½•\n2. ç½‘ç»œè¿æ¥æ­£å¸¸\n\nç‚¹å‡»"ç¡®å®š"ç»§ç»­åŒæ­¥');

                if (!userConfirmed) {
                    return;
                }

                // ç›´æ¥ä»ç”Ÿäº§æ’ç¨‹é¡µé¢è·å–æ•°æ®
                const scheduleUrl = `${BASE_URL}/#/sc/work/productionScheduling?parameterStr=`;

                // åˆ›å»ºä¸€ä¸ªéšè—çš„iframeæ¥åŠ è½½é¡µé¢
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.style.width = '800px';
                iframe.style.height = '600px';
                iframe.src = scheduleUrl;
                document.body.appendChild(iframe);

                // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
                await new Promise((resolve, reject) => {
                    let loadAttempts = 0;
                    const maxAttempts = 10;

                    const checkLoad = () => {
                        loadAttempts++;
                        try {
                            // æ£€æŸ¥iframeæ˜¯å¦åŠ è½½å®Œæˆ
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                            if (iframeDoc && iframeDoc.readyState === 'complete') {
                                setTimeout(resolve, 2000); // é¢å¤–ç­‰å¾…2ç§’ç¡®ä¿æ•°æ®åŠ è½½
                                return;
                            }
                        } catch (e) {
                            // è·¨åŸŸé”™è¯¯æ˜¯é¢„æœŸçš„ï¼Œç»§ç»­ç­‰å¾…
                        }

                        if (loadAttempts < maxAttempts) {
                            setTimeout(checkLoad, 1000);
                        } else {
                            reject(new Error('é¡µé¢åŠ è½½è¶…æ—¶'));
                        }
                    };

                    // å¼€å§‹æ£€æŸ¥
                    setTimeout(checkLoad, 1000);
                });

                // å°è¯•ä»iframeä¸­æå–æ•°æ®
                let workOrders = [];
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    workOrders = extractDataFromPage(iframeDoc);
                } catch (e) {
                    console.log('æ— æ³•ç›´æ¥æå–æ•°æ®ï¼Œå°†æä¾›æ‰‹åŠ¨åŒæ­¥æ–¹å¼:', e);
                }

                // æ¸…ç†iframe
                document.body.removeChild(iframe);

                if (workOrders.length > 0) {
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    localStorage.setItem(STORAGE_KEY, JSON.stringify({
                        data: workOrders,
                        updateTime: new Date().toISOString()
                    }));

                    // é‡æ–°åŠ è½½æ•°æ®
                    loadData();
                    renderList();

                    alert(`âœ… åŒæ­¥æˆåŠŸï¼\n\nè·å–åˆ° ${workOrders.length} ä¸ªå·¥å•æ•°æ®ã€‚\næ•°æ®å·²æ›´æ–°è‡³æœ€æ–°çŠ¶æ€ã€‚`);
                } else {
                    // å¦‚æœæ— æ³•ç›´æ¥æå–ï¼Œæç¤ºç”¨æˆ·æ‰‹åŠ¨æ“ä½œ
                    handleManualSync();
                }

            } catch (error) {
                console.error('åŒæ­¥æ•°æ®å¤±è´¥:', error);
                alert(`âŒ åŒæ­¥å¤±è´¥: ${error.message}\n\nå°†æä¾›æ‰‹åŠ¨åŒæ­¥æ–¹å¼ã€‚`);
                handleManualSync();
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                refreshBtn.textContent = originalText;
                refreshBtn.disabled = false;
            }
        }

        // å¤„ç†æ‰‹åŠ¨åŒæ­¥
        function handleManualSync() {
            const instructions = `
ç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œæ— æ³•è‡ªåŠ¨è·å–æ•°æ®ã€‚

è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ‰‹åŠ¨åŒæ­¥ï¼š

1. ç‚¹å‡»ä¸‹æ–¹"æ‰“å¼€ç”Ÿäº§æ’ç¨‹"æŒ‰é’®
2. åœ¨æ–°æ‰“å¼€çš„é¡µé¢ä¸­ç¡®ä¿å·²ç™»å½•ç³»ç»Ÿ
3. æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·
4. åœ¨æ§åˆ¶å°(Console)ä¸­ç²˜è´´å¹¶æ‰§è¡Œä»¥ä¸‹ä»£ç ï¼š

javascript:(function(){const rows=document.querySelectorAll('tbody tr');const data=[];const seen=new Set();rows.forEach(row=>{const cells=row.querySelectorAll('td');if(cells.length>5){let w='',p='',t='',d='';for(let i=0;i<cells.length;i++){const txt=cells[i].textContent?.trim()||'';if(/^(WORK|MO)\\d+$/.test(txt))w=txt;if(/^[RN]\\.[FEP]-\\d+/.test(txt))t=txt;if(/^\\d{4}-\\d{2}-\\d{2}$/.test(txt)&&!d)d=txt;if(txt.length>3&&/[\\u4e00-\\u9fa5]/.test(txt)&&!/^\\d{2}\\.\\d{3}/.test(txt)&&!/\\d{4}-\\d{2}-\\d{2}/.test(txt)&&txt.length<50){if(txt.includes('æµ‹è¯•')||txt.includes('è®¾å¤‡')||txt.includes('æ²»å…·')||txt.includes('éªŒè¯'))p=txt;else if(!p)p=txt;}}if(t&&!seen.has(t)){seen.add(t);data.push({workOrderNo:w,taskNo:t,projectName:p,orderDate:d});}}});data.sort((a,b)=>(b.orderDate||'').localeCompare(a.orderDate||''));const json=JSON.stringify({data:data,updateTime:new Date().toISOString()});localStorage.setItem('work_order_data',json);alert('å·²åŒæ­¥'+data.length+'ä¸ªå·¥å•æ•°æ®ï¼\\n\\nè¯·è¿”å›æŸ¥è¯¢å·¥å…·é¡µé¢åˆ·æ–°æŸ¥çœ‹ã€‚');})();

5. æ‰§è¡Œåä¼šæç¤ºåŒæ­¥æˆåŠŸï¼Œåˆ·æ–°æœ¬é¡µé¢å³å¯
            `;

            alert(instructions);

            // æ‰“å¼€ç”Ÿäº§æ’ç¨‹é¡µé¢
            if (confirm('æ˜¯å¦ç°åœ¨æ‰“å¼€ç”Ÿäº§æ’ç¨‹é¡µé¢ï¼Ÿ')) {
                window.open(`${BASE_URL}/#/sc/work/productionScheduling?parameterStr=`, '_blank');
            }
        }



        // ==========================
        // è‡ªåŠ¨åŒæ­¥é€»è¾‘ (V2.0)
        // ==========================
        async function startAutoSync() {
            const btn = document.querySelector('[onclick="startAutoSync()"]');
            const originalText = btn.textContent;

            try {
                // 1. å¯åŠ¨åç«¯ç›‘å¬
                const watchPromise = fetch(`${API_BASE_URL}/api/watch-schedule-export`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ timeoutMs: 300000 }) // 5åˆ†é’Ÿè¶…æ—¶
                }).then(r => r.json());

                // 2. æ‰“å¼€KIMDé¡µé¢è®©è„šæœ¬è‡ªåŠ¨ç‚¹å‡»å¯¼å‡º
                // æ·»åŠ  autoExport=true å‚æ•°
                const targetUrl = `${BASE_URL}/#/sc/work/productionScheduling?autoExport=true&t=${Date.now()}`;
                window.open(targetUrl, '_blank');

                // 3. æ›´æ–°UIå¹¶ç­‰å¾…
                btn.textContent = 'â³ ç­‰å¾…å¯¼å‡º...';
                btn.disabled = true;

                const result = await watchPromise;

                if (result.success) {
                    alert(`âœ… åŒæ­¥æˆåŠŸï¼\n\nè‡ªåŠ¨æŠ“å–å¹¶å¯¼å…¥äº† ${result.count} æ¡æ•°æ®ã€‚\næ–‡ä»¶: ${result.file}`);
                    loadData();
                } else {
                    alert(`âš ï¸ åŒæ­¥æœªå®Œæˆ: ${result.message}`);
                }

            } catch (e) {
                console.error('AutoSync error:', e);
                alert('æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼Œè¯·ç¡®ä¿æœ¬åœ°æœåŠ¡å·²å¯åŠ¨');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // ä»é¡µé¢ä¸­æå–æ•°æ®
        function extractDataFromPage(doc) {
            const workOrders = [];
            const seen = new Set();

            // å°è¯•ä¸åŒçš„é€‰æ‹©å™¨æ¥è·å–è¡¨æ ¼æ•°æ®
            const selectors = [
                'tbody tr',
                '.ant-table-tbody tr',
                'table tr',
                '#data-table tbody tr'
            ];

            let rows = [];
            for (const selector of selectors) {
                rows = doc.querySelectorAll(selector);
                if (rows.length > 0) break;
            }

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 5) { // ç¡®ä¿æœ‰è¶³å¤Ÿçš„åˆ—
                    let workOrderNo = '';
                    let taskNo = '';
                    let projectName = '';
                    let orderDate = '';

                    // éå†æ‰€æœ‰å•å…ƒæ ¼æå–ä¿¡æ¯
                    cells.forEach(cell => {
                        const txt = cell.textContent?.trim() || '';

                        // æå–å·¥å•å·
                        if (/^(WORK|MO)\d+$/.test(txt)) {
                            workOrderNo = txt;
                        }
                        // æå–ä»»åŠ¡å·
                        else if (/^[RN]\.[FEP]-\d+/.test(txt)) {
                            taskNo = txt;
                        }
                        // æå–æ—¥æœŸ (æ”¾å®½é™åˆ¶)
                        else if (/^\d{4}-\d{2}-\d{2}/.test(txt) && !orderDate) {
                            orderDate = txt;
                        }
                        // æå–é¡¹ç›®åç§°
                        else if (txt.length > 3 && /[\u4e00-\u9fa5]/.test(txt) &&
                            !/^\d{2}\.\d{3}/.test(txt) &&
                            !/\d{4}-\d{2}-\d{2}/.test(txt) &&
                            txt.length < 50) {
                            if (txt.includes('æµ‹è¯•') || txt.includes('è®¾å¤‡') ||
                                txt.includes('æ²»å…·') || txt.includes('éªŒè¯')) {
                                projectName = txt;
                            } else if (!projectName) {
                                projectName = txt;
                            }
                        }
                    });

                    // ç¡®ä¿ä»»åŠ¡å·å”¯ä¸€ä¸”æœ‰æ•ˆ
                    if (taskNo && !seen.has(taskNo)) {
                        seen.add(taskNo);
                        workOrders.push({
                            workOrderNo: workOrderNo,
                            taskNo: taskNo,
                            projectName: projectName,
                            orderDate: orderDate
                        });
                    }
                }
            });

            // æŒ‰æ—¥æœŸå€’åºæ’åˆ—
            workOrders.sort((a, b) => (b.orderDate || '').localeCompare(a.orderDate || ''));

            return workOrders;
        }

        // è§¦å‘æ–‡ä»¶é€‰æ‹©
        function triggerImport() {
            document.getElementById('import-excel').click();
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function (e) {
                const base64 = e.target.result.split(',')[1];

                const btn = document.querySelector('[onclick="triggerImport()"]');
                const originalText = btn.textContent;
                btn.textContent = 'å¯¼å…¥ä¸­...';
                btn.disabled = true;

                try {
                    const response = await fetch(`${API_BASE_URL}/api/import-work-orders`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ fileContent: base64 })
                    });

                    const data = await response.json();
                    if (data.success) {
                        alert(`âœ… å¯¼å…¥æˆåŠŸï¼\n\nå…±æ›´æ–° ${data.count} æ¡å·¥å•æ•°æ®ã€‚`);
                        loadData(); // é‡æ–°åŠ è½½æ•°æ®
                    } else {
                        alert(`âŒ å¯¼å…¥å¤±è´¥: ${data.message}`);
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    alert('âŒ å¯¼å…¥å‡ºé”™ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œã€‚');
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                    event.target.value = ''; // é‡ç½®æ–‡ä»¶è¾“å…¥
                }
            };
            reader.readAsDataURL(file);
        }

        // å¼ºåˆ¶åˆ·æ–°æ•°æ®ï¼ˆæ¸…é™¤ç¼“å­˜å¹¶é‡æ–°åŠ è½½ï¼‰
        function forceRefresh() {
            if (confirm('æ­¤æ“ä½œå°†æ¸…é™¤æœ¬åœ°ç¼“å­˜å¹¶é‡æ–°åŠ è½½åˆå§‹æ•°æ®ã€‚\n\næ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }
    </script>
</body>

</html>