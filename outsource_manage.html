<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿç®¡ç†ä¸­å¿ƒ</title>
    <style>
        :root {
            --bg-color: #f1f5f9;
            --card-bg: #ffffff;
            --card-border: #cbd5e1;
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --success: #16a34a;
            --warning: #ea580c;
            --danger: #dc2626;
            --text-main: #0f172a;
            --text-muted: #475569;
            --border: #e2e8f0;
            --radius: 6px;
            --shadow: 4px 4px 0px rgba(15, 23, 42, 0.08);
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar Layout */
        .sidebar {
            width: 180px;
            background: var(--card-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 20px;
            font-weight: 800;
            font-size: 18px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
            color: #1e293b;
        }

        .sidebar-nav {
            padding: 16px 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }

        .nav-item {
            padding: 12px 16px;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 600;
            color: var(--text-muted);
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .nav-item:hover {
            background: #f1f5f9;
            color: var(--primary);
        }

        .nav-item.active {
            background: #eff6ff;
            color: var(--primary);
            border-right: 3px solid var(--primary);
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid var(--border);
        }

        .main-content {
            flex: 1;
            padding: 16px 20px;
            overflow-y: auto;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Common Components */
        h2 {
            margin-top: 0;
            margin-bottom: 24px;
            font-size: 24px;
            font-weight: 800;
        }

        .btn {
            padding: 8px 16px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: white;
            color: var(--text-main);
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #f8fafc;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-danger {
            background: #fef2f2;
            color: var(--danger);
            border-color: #fca5a5;
        }

        .btn-danger:hover {
            background: var(--danger);
            color: white;
        }

        /* Panels & Tables */
        .panel {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--card-border);
            margin-bottom: 24px;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            background: var(--card-bg);
            padding: 16px;
            border-radius: var(--radius);
            border: 1px solid var(--card-border);
            box-shadow: var(--shadow);
        }

        .search-input {
            padding: 8px 12px;
            width: 300px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            outline: none;
        }

        .search-input:focus {
            border-color: var(--primary);
        }

        table {
            width: 100%;
            background: var(--card-bg);
            border-collapse: collapse;
            border-radius: var(--radius);
            overflow: hidden;
            border: 1px solid var(--card-border);
            box-shadow: var(--shadow);
        }

        th,
        td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
            white-space: nowrap;
        }

        th {
            background: #f8fafc;
            font-weight: 700;
            color: var(--text-muted);
            white-space: nowrap;
        }

        tr:hover {
            background: #f1f5f9;
        }

        /* Form & Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: var(--card-bg);
            width: 600px;
            max-width: 90%;
            border-radius: var(--radius);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--card-border);
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            font-size: 18px;
        }

        .modal-body {
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 16px;
        }

        .form-group.full {
            grid-column: span 2;
        }

        .form-group label {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: 0px;
        }

        .form-group input,
        .form-group select {
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-family: inherit;
            font-size: 14px;
            outline: none;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--primary);
        }

        .modal-footer {
            padding: 16px 20px;
            background: #f8fafc;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            font-size: 14px;
            color: var(--text-muted);
        }

        /* Auth specific */
        .layout-grid {
            display: grid;
            grid-template-columns: 340px 1fr;
            gap: 24px;
            align-items: start;
        }

        .tag {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            background: #e2e8f0;
            display: inline-block;
        }

        .tag.admin {
            background: #fee2e2;
            color: #b91c1c;
        }

        .tag.user {
            background: #dbeafe;
            color: #1d4ed8;
        }

        /* æ‰¹é‡æ“ä½œæ¡ */
        .batch-toolbar {
            display: none;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px 20px;
            margin-bottom: 16px;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .batch-info {
            font-size: 14px;
            color: #475569;
            font-weight: 600;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>
    <!-- å·¦ä¾§å¯¼èˆª -->
    <div class="sidebar">
        <div class="sidebar-header">
            ğŸ—„ï¸ æ•°æ®æ ¸å¿ƒ
        </div>
        <div class="sidebar-nav">
            <div class="nav-item active" id="nav-outsource" onclick="switchTab('outsource')">
                â±ï¸ å¤–å€Ÿå·¥æ—¶æ•°æ®
            </div>
            <div class="nav-item" id="nav-auth" onclick="switchTab('auth')">
                âš™ï¸ ç³»ç»Ÿæƒé™ç®¡ç†
            </div>
        </div>
        <div class="sidebar-footer">
            <button class="btn" style="width: 100%;" onclick="window.close()">å…³é—­æ­¤é¡µè¿”å›çœ‹æ¿</button>
        </div>
    </div>

    <!-- å†…å®¹åŒº -->
    <div class="main-content">

        <!-- Tab: å¤–å€Ÿå·¥æ—¶æ•°æ® -->
        <div id="panel-outsource" class="tab-panel active">
            <h2>å¤–å€ŸäººåŠ›æ•°æ®åº“ç®¡ç†</h2>

            <div class="toolbar">
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="searchInput" class="search-input" placeholder="æœç´¢å·¥å•å·ã€å§“åæˆ–é¡¹ç›®..."
                        onkeyup="if(event.key==='Enter') loadData()" style="width: 200px;">
                    <input type="date" id="searchDate" class="search-input" onchange="loadData()" title="æŒ‰å·¥ä½œæ—¥æœŸç­›é€‰">
                    <button class="btn" onclick="loadData()">ğŸ” æœç´¢</button>
                    <button class="btn" style="color:var(--text-muted); border-color:var(--border);"
                        onclick="document.getElementById('searchInput').value=''; document.getElementById('searchDate').value=''; loadData();">æ¸…ç©º</button>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn" onclick="downloadTemplate()"
                        style="color: var(--primary); border-color: var(--primary);">ğŸ“„ ä¸‹è½½æ¨¡æ¿</button>
                    <button class="btn" onclick="handleExcelImport()"
                        style="background: var(--success); color: white; border-color: var(--success);">ğŸ“¥ æ‰¹é‡å¯¼å…¥
                        (Excel/CSV)</button>
                    <button class="btn btn-primary" onclick="openModal()">â• æ–°å¢ä¸€è¡Œ</button>
                </div>
            </div>

            <!-- æ‰¹é‡æ“ä½œæ¡ -->
            <div id="batchToolbar" class="batch-toolbar">
                <div class="batch-info">
                    âœ¨ å·²é€‰ä¸­ <span id="selectedCount" style="color: var(--primary);">0</span> é¡¹è®°å½•
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn" style="color: var(--primary); border-color: var(--primary);"
                        onclick="openBatchEditModal()">
                        âœï¸ æ‰¹é‡ä¿®æ”¹ (å·¥è‰º/å¤‡æ³¨)
                    </button>
                    <button class="btn" style="color: #ef4444; border-color: #ef4444;" onclick="batchDeleteRecords()">
                        ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤é€‰ä¸­
                    </button>
                    <button class="btn" onclick="clearSelection()"
                        style="border: none; background: transparent;">å–æ¶ˆ</button>
                </div>
            </div>

            <table id="dataTable">
                <thead>
                    <tr>
                        <th width="40"><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)"></th>
                        <th>ID</th>
                        <th>æ—¥æœŸ</th>
                        <th>å·¥å•å·</th>
                        <th>é¡¹ç›®åç§°</th>
                        <th>å§“å</th>
                        <th>ç­‰çº§</th>
                        <th>ä¸Šä¸‹ç­æ—¶é—´</th>
                        <th>å·¥æ—¶(H)</th>
                        <th>å¤–åå•ä½</th>
                        <th>å±æ€§</th>
                        <th>å·¥æ—¶æŒ‚é </th>
                        <th>å¤‡æ³¨/è¯´æ˜</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>

            <div class="pagination">
                <span id="pageInfo">å…± 0 æ¡è®°å½•</span>
                <div>
                    <button class="btn" onclick="changePage(-1)" style="padding: 4px 12px;">ä¸Šä¸€é¡µ</button>
                    <span id="currentPage" style="margin: 0 12px; font-weight: 600;">1</span>
                    <button class="btn" onclick="changePage(1)" style="padding: 4px 12px;">ä¸‹ä¸€é¡µ</button>
                </div>
            </div>
        </div>

        <!-- Tab: æƒé™ç®¡ç† -->
        <div id="panel-auth" class="tab-panel">
            <h2>ç³»ç»Ÿæƒé™ä¸è´¦å·åˆ†é…</h2>

            <div class="layout-grid">
                <div class="panel">
                    <h3 id="authFormTitle" style="margin-top: 0; margin-bottom: 20px; font-size: 16px;">æ–°å¢ç³»ç»Ÿæˆæƒ</h3>
                    <form id="authForm" onsubmit="addAuth(event)">
                        <div class="form-group">
                            <label>ç™»å½•è´¦å· (å…¨å°å†™è‹±æ–‡å­—æ¯æ¨è)</label>
                            <input type="text" id="aCode" placeholder="ä¾‹å¦‚: zhangsan" required>
                        </div>
                        <div class="form-group">
                            <label>çœŸå®å§“å</label>
                            <input type="text" id="aName" placeholder="ä¾‹å¦‚: å¼ ä¸‰" required>
                        </div>
                        <div class="form-group">
                            <label>ç™»å½•å¯†ç </label>
                            <input type="text" id="aPass" placeholder="é»˜è®¤è®¾ç½®">
                        </div>
                        <div class="form-group">
                            <label>éƒ¨é—¨åˆ†ç±»</label>
                            <select id="aDept">
                                <option value="ç»„è£…">ç»„è£…</option>
                                <option value="æ¥çº¿">æ¥çº¿</option>
                                <option value="å·¥ç¨‹">å·¥ç¨‹</option>
                                <option value="PMC">PMC</option>
                                <option value="å…¶ä»–">å…¶ä»–</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 24px;">
                            <label>è§’è‰²åˆ†é…</label>
                            <select id="aRole">
                                <option value="user">æ™®é€šæŸ¥é˜…/æ“ä½œå‘˜</option>
                                <option value="admin">ç®¡ç†å‘˜ (æ‹¥æœ‰æˆæƒæ§åˆ¶æƒ)</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">åˆ†é…æ–°è´¦å·</button>
                        <button type="button" class="btn" style="width: 100%; margin-top: 8px; display: none;"
                            id="cancelEditBtn" onclick="resetAuthForm()">å–æ¶ˆç¼–è¾‘</button>
                    </form>
                </div>

                <div style="background: transparent;">
                    <table style="box-shadow: none;">
                        <thead>
                            <tr>
                                <th>ç™»å½•è´¦å·</th>
                                <th>å§“å</th>
                                <th>éƒ¨é—¨å½’å±</th>
                                <th>æƒé™ç­‰çº§</th>
                                <th>æˆæƒæ—¥æœŸ</th>
                                <th width="80">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="userList">
                            <tr>
                                <td colspan="6" style="text-align: center; color: var(--text-muted); padding: 40px;">
                                    è½½å…¥ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- æ–°å¢/ç¼–è¾‘ å·¥æ—¶è®°å½• Modal -->
    <div class="modal-overlay" id="recordModal">
        <div class="modal">
            <div class="modal-header">
                <span id="modalTitle">æ–°å¢è®°å½•</span>
                <button class="btn" style="border:none; padding:4px;" onclick="closeModal()">âœ•</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="recordId">

                <div class="form-group" style="margin-bottom: 0;">
                    <label>æ—¥æœŸ</label>
                    <input type="text" id="f_work_date" placeholder="å¦‚ 1/8">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>å·¥å•å·</label>
                    <input type="text" id="f_work_order">
                </div>
                <div class="form-group full" style="margin-bottom: 0;">
                    <label>é¡¹ç›®åç§°</label>
                    <input type="text" id="f_project_name">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>å§“å</label>
                    <input type="text" id="f_worker_name">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>ç­‰çº§</label>
                    <input type="text" id="f_worker_level" placeholder="å¤§å·¥/ä¸­å·¥/å°å·¥">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>ä¸Šç­æ—¶é—´</label>
                    <input type="time" id="f_start_time" step="1800" onblur="ensureHalfHour(this)"
                        onchange="calcHours()">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>ä¸‹ç­æ—¶é—´</label>
                    <input type="time" id="f_end_time" step="1800" onblur="ensureHalfHour(this)" onchange="calcHours()">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>å·¥æ—¶ (è‡ªåŠ¨è®¡ç®—)</label>
                    <input type="text" id="f_hours" value="0" readonly
                        style="background-color: #f1f5f9; color: #64748b; cursor: not-allowed; border-color: transparent;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>å¤–åå•ä½</label>
                    <input type="text" id="f_supplier">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>å·¥æ—¶æŒ‚é </label>
                    <select id="f_content">
                        <option value="">-- è¯·é€‰æ‹© --</option>
                        <option value="æ¨¡ç»„ç»„è£…">æ¨¡ç»„ç»„è£…</option>
                        <option value="æ•´æœºæ¥æ°”">æ•´æœºæ¥æ°”</option>
                        <option value="å‡ºè´§">å‡ºè´§</option>
                        <option value="é¡¹ç›®ç®¡ç†">é¡¹ç›®ç®¡ç†</option>
                        <option value="é¢†æ–™">é¢†æ–™</option>
                        <option value="ä¸Šçº¿å‡†å¤‡">ä¸Šçº¿å‡†å¤‡</option>
                        <option value="æ€»è£…">æ€»è£…</option>
                        <option value="æ¸…æ´">æ¸…æ´</option>
                        <option value="æ‰“åŒ…">æ‰“åŒ…</option>
                        <option value="ç”µæ§é…çº¿">ç”µæ§é…çº¿</option>
                        <option value="æ•´æœºæ¥çº¿">æ•´æœºæ¥çº¿</option>
                        <option value="é€šç”µé€šæ°”">é€šç”µé€šæ°”</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>å¤‡æ³¨/è¯´æ˜</label>
                    <input type="text" id="f_remark1" placeholder="åŸæœ‰å·¥ä½œå†…å®¹æˆ–æ–°å¤‡æ³¨">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>å±æ€§</label>
                    <select id="f_category" onchange="handleManageCategoryChange()">
                        <option value="å¤–å">å¤–å</option>
                        <option value="KIMD">KIMD</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>å¤–åå•ä½</label>
                    <input type="text" id="f_supplier" placeholder="å¦‚: å¤–å / æŸæŸå…¬å¸">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>ç­æ¬¡</label>
                    <input type="text" id="f_shift">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveRecord()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡ä¿®æ”¹å¼¹çª— -->
    <div class="modal-overlay" id="batchEditOverlay">
        <div class="modal" style="width: 450px;">
            <div class="modal-header">
                <div class="modal-title" style="font-weight: 800; font-size: 18px;">âœï¸ æ‰¹é‡ä¿®æ”¹é€‰ä¸­é¡¹</div>
                <button class="btn" style="border:none; padding:4px;" onclick="closeBatchEditModal()">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>å·¥æ—¶æŒ‚é  (ç»Ÿä¸€ä¿®æ”¹ä¸º)</label>
                    <select id="batchField_content">
                        <option value="">-- ä¿æŒåŸæ · (ä¸åšä¿®æ”¹) --</option>
                        <option value="æ¨¡ç»„ç»„è£…">æ¨¡ç»„ç»„è£…</option>
                        <option value="æ•´æœºæ¥æ°”">æ•´æœºæ¥æ°”</option>
                        <option value="å‡ºè´§">å‡ºè´§</option>
                        <option value="é¡¹ç›®ç®¡ç†">é¡¹ç›®ç®¡ç†</option>
                        <option value="é¢†æ–™">é¢†æ–™</option>
                        <option value="ä¸Šçº¿å‡†å¤‡">ä¸Šçº¿å‡†å¤‡</option>
                        <option value="æ€»è£…">æ€»è£…</option>
                        <option value="æ¸…æ´">æ¸…æ´</option>
                        <option value="æ‰“åŒ…">æ‰“åŒ…</option>
                        <option value="ç”µæ§é…çº¿">ç”µæ§é…çº¿</option>
                        <option value="æ•´æœºæ¥çº¿">æ•´æœºæ¥çº¿</option>
                        <option value="é€šç”µé€šæ°”">é€šç”µé€šæ°”</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å¤‡æ³¨/è¯´æ˜ (ç»Ÿä¸€ä¿®æ”¹ä¸º)</label>
                    <input type="text" id="batchField_remark1" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹">
                </div>
                <p style="font-size: 12px; color: #64748b; margin-top: 12px;">æ³¨ï¼šæœªé€‰ä¸­çš„å­—æ®µå°†ä¿æŒåŸæœ‰æ•°å€¼ä¸å˜ã€‚</p>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeBatchEditModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveBatchEdit()">ç«‹å³åº”ç”¨</button>
            </div>
        </div>
    </div>

    <script>
        // é—¨ç¦æ£€æŸ¥
        const stored = localStorage.getItem('currentUser');
        if (!stored) {
            alert('æƒé™ä¸è¶³ï¼Œè¯·å…ˆç™»å½•ç³»ç»Ÿ');
            location.href = 'index.html';
        } else {
            const u = JSON.parse(stored);
            if (u.userCode !== 'wangjian' && u.role !== 'admin') {
                alert('æƒé™ä¸è¶³ï¼Œä»…ç®¡ç†å‘˜å¯è®¿é—®åå°æ•°æ®');
                location.href = 'index.html';
            }
        }

        function ensureHalfHour(input) {
            if (!input.value) return;
            let [h, m] = input.value.split(':').map(Number);
            // å‘ä¸‹å–æ•´ï¼šä¸æ»¡åŠå°æ—¶ä¸è®¡
            if (m < 30) {
                m = 0;
            } else {
                m = 30;
            }
            const newVal = String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
            if (input.value !== newVal) {
                input.value = newVal;
                if (typeof calcHours === 'function') calcHours();
            }
        }

        // é¡µé¢åˆ‡é¡µ
        function switchTab(tabId) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(el => el.classList.remove('active'));

            document.getElementById('nav-' + tabId).classList.add('active');
            document.getElementById('panel-' + tabId).classList.add('active');

            if (tabId === 'auth') {
                loadUsers();
            } else {
                loadData();
            }
        }

        // ======= å¤–å€ŸäººåŠ›æ•°æ®é€»è¾‘ =======
        let currentPage = 1;

        // è‡ªåŠ¨è®¡ç®—å·¥æ—¶ (é…åˆç”¨æˆ· Excel å…¬å¼é€»è¾‘)
        function calcHours() {
            const stValue = document.getElementById('f_start_time').value;
            const etValue = document.getElementById('f_end_time').value;
            const hoursEl = document.getElementById('f_hours');

            // 1. å¦‚æœç»“æŸæ—¶é—´ä¸ºç©º (Excel: G369="")
            if (!etValue) {
                hoursEl.value = "ç­‰å¾…è®¡ç®—";
                return;
            }

            // 2. å¦‚æœå¼€å§‹æ—¶é—´ä¸ºç©º
            if (!stValue) {
                hoursEl.value = "0";
                return;
            }

            const [h1, m1] = stValue.split(':').map(Number);
            const [h2, m2] = etValue.split(':').map(Number);

            // 3. å¦‚æœå¼€å§‹æ—¶é—´å°æ—¶ > 11 (Excel: HOUR(F369)>11)
            if (h1 > 11) {
                hoursEl.value = "ç‰¹æ®Š";
                return;
            }

            // 4. è®¡ç®—åŸå§‹æ—¶é•¿ (å°æ—¶ä¸ºå•ä½)
            let rawHours = (h2 + m2 / 60) - (h1 + m1 / 60);
            if (rawHours < 0) rawHours += 24; // è·¨å¤©è¡¥é½

            // 5. æ ¹æ®æ—¶é•¿æ‰£é™¤ (Excel é€»è¾‘: HOUR(G369-F369))
            const durationHourPart = Math.floor(rawHours + 0.0001);

            let finalHours = rawHours;
            if (durationHourPart <= 3) {
                finalHours = rawHours;
            } else if (durationHourPart >= 4 && durationHourPart <= 9) {
                finalHours = rawHours - 1;
            } else {
                finalHours = rawHours - 1.5;
            }

            hoursEl.value = finalHours.toFixed(1);
        }

        function handleManageCategoryChange() {
            const cat = document.getElementById('f_category').value;
            const levelEl = document.getElementById('f_worker_level');
            const supplierEl = document.getElementById('f_supplier');

            if (cat === 'KIMD') {
                levelEl.value = '';
                levelEl.disabled = true;
                levelEl.style.background = '#f1f5f9';

                supplierEl.value = '';
                supplierEl.disabled = true;
                supplierEl.style.background = '#f1f5f9';
            } else {
                levelEl.disabled = false;
                levelEl.style.background = 'white';

                supplierEl.disabled = false;
                supplierEl.style.background = 'white';
            }
        }

        async function loadData() {
            const keyword = document.getElementById('searchInput').value;
            const searchDateRaw = document.getElementById('searchDate').value;
            let formattedDate = '';
            if (searchDateRaw) {
                const parts = searchDateRaw.split('-');
                if (parts.length === 3) {
                    // è½¬æˆ 2/25 çš„æ— å‰å¯¼é›¶æ ¼å¼
                    formattedDate = parseInt(parts[1], 10) + '/' + parseInt(parts[2], 10);
                }
            }

            try {
                const res = await fetch(`/api/outsource-records?page=${currentPage}&pageSize=20&keyword=${encodeURIComponent(keyword)}&searchDate=${encodeURIComponent(formattedDate)}`);
                const result = await res.json();

                if (result.success) {
                    renderTable(result.data);
                    document.getElementById('pageInfo').innerText = `å…± ${result.total} æ¡è®°å½•`;
                    document.getElementById('currentPage').innerText = currentPage;
                } else {
                    alert('è·å–æ•°æ®å¤±è´¥: ' + result.message);
                }
            } catch (err) {
                console.error('åŠ è½½æŠ¥é”™:', err);
                alert('æ•°æ®åŠ è½½å¼‚å¸¸: ' + err.message);
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="14" style="text-align:center; padding: 40px; color:#94a3b8;">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³è®°å½•</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(item => `
        <tr data-id="${item.id}">
          <td style="text-align:center;"><input type="checkbox" class="row-checkbox" value="${item.id}" onclick="updateSelectedCount()"></td>
          <td style="color:#64748b; font-size:12px;">#${item.id}</td>
          <td>${item.work_date || '-'}</td>
          <td style="font-family:monospace; font-weight:600;">${item.work_order || '-'}</td>
          <td>${item.project_name || '-'}</td>
          <td style="font-weight:600;">${item.worker_name || '-'}</td>
          <td>${item.worker_level || '-'}</td>
          <td style="color:#64748b; font-size:12px; font-family:monospace;">${item.start_time || '-'} ~ ${item.end_time || '-'}</td>
          <td style="color:var(--primary); font-weight:700;">${item.hours}</td>
          <td>${item.supplier || '-'}</td>
          <td><span class="tag" style="background:${item.category === 'KIMD' ? '#fee2e2' : '#dbeafe'}; color:${item.category === 'KIMD' ? '#b91c1c' : '#1d4ed8'};">${item.category || 'å¤–å'}</span></td>
          <td><span class="tag" style="background:#e2e8f0; color:#475569;">${item.content || 'æœªæŒ‡å®š'}</span></td>
          <td>${item.remark1 || '-'}</td>
          <td>
            <button class="btn" style="padding:4px 8px; font-size:12px;" onclick="editRecord(this.getAttribute('data-item'))" data-item='${JSON.stringify(item).replace(/'/g, "&#39;")}'>ç¼–è¾‘</button>
            <button class="btn btn-danger" style="padding:4px 8px; font-size:12px;" onclick="deleteRecord(${item.id})">åˆ é™¤</button>
          </td>
        </tr>
      `).join('');

            // é‡ç½®å…¨é€‰æ¡†
            document.getElementById('selectAll').checked = false;
            updateSelectedCount();
        }

        function toggleSelectAll(master) {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(cb => cb.checked = master.checked);
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const checked = document.querySelectorAll('.row-checkbox:checked');
            const count = checked.length;
            document.getElementById('selectedCount').innerText = count;
            document.getElementById('batchToolbar').style.display = count > 0 ? 'flex' : 'none';
            // å¦‚æœä¸æ˜¯æ‰€æœ‰è¡Œéƒ½é€‰ä¸­ï¼Œå…¨é€‰æ¡†å–æ¶ˆé’©
            const all = document.querySelectorAll('.row-checkbox');
            if (all.length > 0) {
                document.getElementById('selectAll').checked = (count === all.length);
            }
        }

        function clearSelection() {
            document.getElementById('selectAll').checked = false;
            toggleSelectAll(document.getElementById('selectAll'));
        }

        async function batchDeleteRecords() {
            const checked = document.querySelectorAll('.row-checkbox:checked');
            const ids = Array.from(checked).map(cb => parseInt(cb.value));
            if (ids.length === 0) return;

            if (confirm(`ç¡®å®šè¦æ‰¹é‡åˆ é™¤é€‰ä¸­çš„ ${ids.length} æ¡è®°å½•å—ï¼Ÿè­¦å‘Šï¼šæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                try {
                    const res = await fetch('/api/outsource-record/batch-delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ids })
                    });
                    const data = await res.json();
                    if (data.success) {
                        alert(data.message);
                        loadData();
                    } else {
                        alert('æ‰¹é‡åˆ é™¤å¤±è´¥: ' + data.message);
                    }
                } catch (e) { alert('ç½‘ç»œé”™è¯¯'); }
            }
        }

        function openBatchEditModal() {
            document.getElementById('batchEditOverlay').style.display = 'flex';
            document.getElementById('batchField_content').value = '';
            document.getElementById('batchField_remark1').value = '';
        }

        function closeBatchEditModal() {
            document.getElementById('batchEditOverlay').style.display = 'none';
        }

        async function saveBatchEdit() {
            const checked = document.querySelectorAll('.row-checkbox:checked');
            const ids = Array.from(checked).map(cb => parseInt(cb.value));
            const newContent = document.getElementById('batchField_content').value;
            const newRemark = document.getElementById('batchField_remark1').value.trim();

            if (!newContent && !newRemark) {
                alert('è¯·è‡³å°‘å¡«å†™ä¸€ä¸ªä¿®æ”¹é¡¹');
                return;
            }

            const payload = { ids };
            if (newContent) payload.content = newContent;
            if (newRemark) payload.remark1 = newRemark;

            try {
                const res = await fetch('/api/outsource-record/batch-update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (data.success) {
                    alert(data.message);
                    closeBatchEditModal();
                    loadData();
                } else {
                    alert('æ‰¹é‡ä¿®æ”¹å¤±è´¥: ' + data.message);
                }
            } catch (e) { alert('ç½‘ç»œé”™è¯¯'); }
        }

        function changePage(delta) {
            if (currentPage + delta > 0) {
                currentPage += delta;
                loadData();
            }
        }

        function openModal(itemObj = null) {
            document.getElementById('recordModal').style.display = 'flex';
            const fields = ['id', 'work_date', 'work_order', 'project_name', 'worker_name', 'worker_level', 'start_time', 'end_time', 'hours', 'supplier', 'content', 'shift', 'remark1', 'category'];

            if (itemObj) {
                document.getElementById('modalTitle').innerText = 'ç¼–è¾‘è®°å½•';
                document.getElementById('recordId').value = itemObj.id;
                fields.forEach(f => {
                    if (f !== 'id') {
                        let val = itemObj[f] || '';
                        // ä¿®æ­£ type="time" è¾“å…¥æ¡†åªè®¤ "HH:MM" ä¸”å¿…é¡»è¡¥é›¶çš„é—®é¢˜
                        if ((f === 'start_time' || f === 'end_time') && val && val !== '-') {
                            const parts = val.split(':');
                            if (parts.length >= 2) {
                                val = parts[0].padStart(2, '0') + ':' + parts[1].padStart(2, '0');
                            }
                        }
                        // å¤„ç†ä¹‹å‰ä¿å­˜çš„ '-' ä¼ªæ—¶åˆ†ï¼Œé¿å…å†™å…¥ time è¾“å…¥æ¡†é€ æˆé”™è¯¯
                        if ((f === 'start_time' || f === 'end_time') && val === '-') {
                            val = '';
                        }
                        document.getElementById('f_' + f).value = val;
                    }
                });
            } else {
                document.getElementById('modalTitle').innerText = 'æ–°å¢è®°å½•';
                document.getElementById('recordId').value = '';
                fields.forEach(f => {
                    if (f !== 'id') document.getElementById('f_' + f).value = '';
                });
                document.getElementById('f_hours').value = '0';
            }
            handleManageCategoryChange();
        }

        function closeModal() {
            document.getElementById('recordModal').style.display = 'none';
        }

        async function saveRecord() {
            const id = document.getElementById('recordId').value;
            const name = document.getElementById('f_worker_name').value.trim();
            const content = document.getElementById('f_content').value;
            const category = document.getElementById('f_category').value;
            const level = document.getElementById('f_worker_level').value;

            if (!name) {
                alert("è¯·è¾“å…¥äººå‘˜å§“å");
                return;
            }
            if (!content) {
                alert("è¯·é€‰æ‹©å·¥æ—¶æŒ‚é ï¼ˆå·¥è‰ºï¼‰");
                return;
            }
            if (category === 'å¤–å' && !level) {
                alert("å¤–åäººå‘˜å¿…é¡»å¡«å†™/é€‰æ‹©ç­‰çº§");
                return;
            }

            const payload = {
                work_date: document.getElementById('f_work_date').value,
                work_order: document.getElementById('f_work_order').value,
                project_name: document.getElementById('f_project_name').value,
                worker_name: document.getElementById('f_worker_name').value,
                worker_level: document.getElementById('f_worker_level').value,
                start_time: document.getElementById('f_start_time').value,
                end_time: document.getElementById('f_end_time').value,
                hours: isNaN(parseFloat(document.getElementById('f_hours').value)) ? 0 : parseFloat(document.getElementById('f_hours').value),
                supplier: document.getElementById('f_supplier').value,
                content: document.getElementById('f_content').value,
                remark1: document.getElementById('f_remark1').value,
                shift: document.getElementById('f_shift').value,
                category: document.getElementById('f_category').value
            };

            const url = id ? `/api/outsource-record/${id}` : `/api/outsource-record`;
            const method = id ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await res.json();
                if (data.success) { closeModal(); loadData(); } else { alert('ä¿å­˜å¤±è´¥: ' + data.message); }
            } catch (e) { alert('ç½‘ç»œé”™è¯¯'); }
        }

        async function deleteRecord(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
                try {
                    const res = await fetch(`/api/outsource-record/${id}`, { method: 'DELETE' });
                    const data = await res.json();
                    if (data.success) loadData(); else alert('åˆ é™¤å¤±è´¥');
                } catch (e) { alert('ç½‘ç»œé”™è¯¯'); }
            }
        }

        function editRecord(itemStr) {
            try {
                const item = JSON.parse(itemStr);
                openModal(item);
            } catch (e) {
                alert('è§£æè®°å½•æ•°æ®å¤±è´¥');
            }
        }


        // ======= æƒé™è´¦å·é€»è¾‘ =======
        async function loadUsers() {
            try {
                const res = await fetch('/api/auth/users').then(r => r.json());
                if (!res.success) return alert("è¯»å–è´¦å·åˆ—è¡¨å¤±è´¥");
                const tb = document.getElementById('userList');
                if (res.data.length === 0) {
                    tb.innerHTML = '<tr><td colspan="6" align="center" style="padding: 40px;">ä»…æœ‰å†…ç½®è´¦å·</td></tr>';
                    return;
                }
                tb.innerHTML = res.data.map(u => `
          <tr ondblclick="editUserAuth('${u.userCode}', '${u.userName}', '${u.department}', '${u.role}')" style="cursor: pointer;" title="åŒå‡»ä¿®æ”¹è®°å½•">
            <td><strong>${u.userCode}</strong></td>
            <td>${u.userName}</td>
            <td><span class="tag" style="background:#f1f5f9; color:#475569;">${u.department || 'æœªåˆ†é…'}</span></td>
            <td><span class="tag ${u.role === 'admin' ? 'admin' : 'user'}">${u.role === 'admin' ? 'ç³»ç»Ÿè¶…ç®¡' : 'æ“ä½œå‘˜'}</span></td>
            <td style="color:#64748b; font-size:12px">${new Date(u.createdAt).toLocaleString()}</td>
            <td>
              ${u.userCode === 'wangjian' ? '<span style="color:#cbd5e1;font-size:12px">åŸç”Ÿä¿ç•™</span>' : `<button class="btn btn-danger" style="padding: 4px 8px; font-size:12px" onclick="delUser('${u.userCode}')">ç§»é™¤</button>`}
            </td>
          </tr>
        `).join('');
            } catch (e) { console.error(e); }
        }

        async function addAuth(e) {
            e.preventDefault();
            const payload = {
                userCode: document.getElementById('aCode').value.trim(),
                userName: document.getElementById('aName').value.trim(),
                password: document.getElementById('aPass').value,
                role: document.getElementById('aRole').value,
                department: document.getElementById('aDept').value
            };

            try {
                const res = await fetch('/api/auth/addUser', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }).then(r => r.json());

                if (res.success) {
                    document.getElementById('authForm').reset();
                    resetAuthForm();
                    loadUsers();
                } else {
                    alert(`æ“ä½œå¤±è´¥: ${res.message}`);
                }
            } catch (error) { alert("ç½‘ç»œé”™è¯¯"); }
        }

        function editUserAuth(code, name, dept, role) {
            if (code === 'wangjian') return alert('å†…ç½®å¤§ç®¡ç†å‘˜è´¦å·å—ä¿æŠ¤ä¸å¯ä¿®æ”¹');
            document.getElementById('aCode').value = code;
            document.getElementById('aCode').readOnly = true;
            document.getElementById('aCode').style.background = '#f1f5f9';
            document.getElementById('aName').value = name || '';
            document.getElementById('aPass').value = '';
            document.getElementById('aPass').placeholder = 'ç½®ç©ºåˆ™ä¸ä¿®æ”¹å¯†ç ';
            document.getElementById('aDept').value = dept || 'ç»„è£…';
            document.getElementById('aRole').value = role || 'user';
            document.querySelector('#authForm button[type="submit"]').textContent = 'ğŸ’¾ ä¿å­˜ä¿®æ”¹';
            document.getElementById('authFormTitle').innerHTML = 'âœï¸ ä¿®æ”¹ç³»ç»Ÿæˆæƒ: <strong>' + code + '</strong>';
            document.getElementById('cancelEditBtn').style.display = 'block';
        }

        function resetAuthForm() {
            document.getElementById('aCode').readOnly = false;
            document.getElementById('aCode').style.background = '';
            document.getElementById('aPass').placeholder = 'é»˜è®¤è®¾ç½®';
            document.querySelector('#authForm button[type="submit"]').textContent = 'åˆ†é…æ–°è´¦å·';
            document.getElementById('authFormTitle').textContent = 'æ–°å¢ç³»ç»Ÿæˆæƒ';
            document.getElementById('cancelEditBtn').style.display = 'none';
            document.getElementById('authForm').reset();
        }

        async function delUser(code) {
            if (!confirm(`ä½ ç¡®å®šè¦åŠé”€ ${code} çš„è®¿é—®æƒé™å—ï¼Ÿ`)) return;
            const res = await fetch(`/api/auth/users/${encodeURIComponent(code)}`, { method: 'DELETE' }).then(r => r.json());
            if (res.success) loadUsers(); else alert("åŠé”€å¤±è´¥ï¼š" + res.message);
        }
        // ======= Excel å¯¼å…¥ç›¸å…³åŠŸèƒ½ =======
        function downloadTemplate() {
            if (typeof XLSX === 'undefined') return alert('åº“å°šæœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•');
            const worksheet = XLSX.utils.json_to_sheet([{
                "æ—¥æœŸ": "2026/02/25",
                "å·¥å•å·": "WORK-001",
                "é¡¹ç›®åç§°": "æµ‹è¯•é¡¹ç›®",
                "å§“å": "å¼ ä¸‰",
                "ç­‰çº§": "å¤§å·¥",
                "ä¸Šç­æ—¶é—´": "08:00",
                "ä¸‹ç­æ—¶é—´": "17:30",
                "å·¥æ—¶": 9.5,
                "å¤–åå•ä½": "æŸæŸå…¬å¸",
                "å·¥æ—¶æŒ‚é ": "æ¨¡ç»„ç»„è£…",
                "å¤‡æ³¨/è¯´æ˜": "åŸæœ‰å†…å®¹æˆ–æ–°å¤‡æ³¨",
                "ç­æ¬¡": "ç™½ç­"
            }]);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "å¯¼å…¥æ¨¡æ¿");
            XLSX.writeFile(workbook, "å¤–å€ŸäººåŠ›å¯¼å…¥æ¨¡æ¿.xlsx");
        }

        function handleExcelImport() {
            if (typeof XLSX === 'undefined') return alert('åº“å°šæœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•');
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx, .xls, .csv';
            input.style.display = 'none';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function (evt) {
                    try {
                        const data = evt.target.result;
                        const workbook = XLSX.read(data, { type: 'binary' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(firstSheet, { defval: "" });

                        if (json.length === 0) return alert('ç©ºæ–‡ä»¶æˆ–æœªæ‰¾åˆ°æ•°æ®');

                        const records = json.map(row => {
                            return {
                                work_date: (row['æ—¥æœŸ'] || row['Date'] || '').toString(),
                                work_order: (row['å·¥å•å·'] || row['å·¥å•'] || row['Order'] || '').toString(),
                                project_name: (row['é¡¹ç›®åç§°'] || row['é¡¹ç›®'] || row['Project'] || '').toString(),
                                worker_name: (row['å§“å'] || row['å‘˜å·¥å§“å'] || row['Name'] || '').toString(),
                                worker_level: (row['ç­‰çº§'] || row['çº§åˆ«'] || row['Level'] || '').toString(),
                                start_time: (row['ä¸Šç­æ—¶é—´'] || row['å¼€å§‹æ—¶é—´'] || row['Start'] || '').toString(),
                                end_time: (row['ä¸‹ç­æ—¶é—´'] || row['ç»“æŸæ—¶é—´'] || row['End'] || '').toString(),
                                hours: parseFloat(row['å·¥æ—¶'] || row['æŠ•å…¥å·¥æ—¶'] || row['Hours'] || 0) || 0,
                                supplier: (row['å¤–åå•ä½'] || row['å•ä½'] || row['Supplier'] || '').toString(),
                                content: (row['å·¥æ—¶æŒ‚é '] || row['å·¥ä½œæ€§è´¨'] || row['å·¥ä½œå†…å®¹'] || row['Content'] || '').toString(),
                                remark1: (row['å¤‡æ³¨/è¯´æ˜'] || row['å¤‡æ³¨'] || row['åŸå·¥ä½œå†…å®¹'] || row['Remark'] || '').toString(),
                                shift: (row['ç­æ¬¡'] || row['Shift'] || '').toString()
                            };
                        }).filter(r => r.work_order || r.worker_name); // è¿‡æ»¤ç©ºè¡Œ

                        if (records.length === 0) return alert('æœªæ‰¾åˆ°æœ‰æ•ˆçš„è®°å½•(è‡³å°‘åŒ…å«å·¥å•å·æˆ–å§“å)');

                        if (confirm(`è§£ææˆåŠŸï¼å…±å‘ç° ${records.length} æ¡æœ‰æ•ˆè®°å½•ï¼Œæ˜¯å¦ç«‹å³å¯¼å…¥ï¼Ÿ`)) {
                            fetch('/api/outsource-record/import', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ records })
                            }).then(r => r.json()).then(res => {
                                if (res.success) {
                                    alert(`ğŸˆ å¯¼å…¥æˆåŠŸï¼å…±æ–°å¢ ${res.count} æ¡è®°å½•ã€‚`);
                                    loadData();
                                } else {
                                    alert('å¯¼å…¥å¤±è´¥: ' + res.message);
                                }
                            }).catch(err => {
                                alert('ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨å¼‚å¸¸');
                            });
                        }
                    } catch (err) {
                        alert('è§£æ Excel æ–‡ä»¶å‡ºé”™: ' + err.message);
                    }
                };
                reader.readAsBinaryString(file);
            };
            document.body.appendChild(input);
            input.click();
            document.body.removeChild(input);
        }

        // åˆå§‹åŒ–é»˜è®¤ Tab æ•°æ®
        loadData();
    </script>
</body>

</html>